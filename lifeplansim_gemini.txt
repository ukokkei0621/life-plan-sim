import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { ComposedChart, Line, Area, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Legend, PieChart as RePieChart, Pie, Cell } from 'recharts';
import { Plus, Trash2, TrendingUp, DollarSign, User, Briefcase, AlertCircle, CheckCircle2, Users, Calculator, Activity, Baby, Table as TableIcon, ChevronDown, ChevronUp, GraduationCap, Coins, PiggyBank, Home, Save, TrendingDown, PieChart, Repeat, ArrowRight, Landmark, ArrowDownCircle, ArrowUpCircle, Sparkles, Bot, BarChart2, ShieldAlert, Settings2, Info, X, BookOpen, Maximize2, Minimize2, ExternalLink, SlidersHorizontal, Wallet, Flag, AlertTriangle } from 'lucide-react';

// --- Gemini API Key ---
const apiKey = "";

// --- Constants for Portfolio ---
const ASSET_CLASSES = {
  domestic_stock: { id: 'domestic_stock', name: 'å›½å†…æ ªå¼', return: 4.0, risk: 20.0, color: '#f87171' },
  us_stock: { id: 'us_stock', name: 'ç±³å›½æ ªå¼', return: 11.0, risk: 19.0, color: '#ef4444' },
  ex_us_stock: { id: 'ex_us_stock', name: 'å…ˆé€²å›½æ ª(é™¤ç±³)', return: 7.5, risk: 21.0, color: '#fb923c' },
  emerging_stock: { id: 'emerging_stock', name: 'æ–°èˆˆå›½æ ªå¼', return: 5.6, risk: 25.0, color: '#fbbf24' },
  domestic_bond: { id: 'domestic_bond', name: 'å›½å†…å‚µåˆ¸', return: 1.0, risk: 3.0, color: '#60a5fa' },
  us_agg_bond: { id: 'us_agg_bond', name: 'ç±³å›½ç·åˆå‚µåˆ¸', return: 3.5, risk: 11.0, color: '#818cf8' },
  reit: { id: 'reit', name: 'REIT', return: 6.0, risk: 18.0, color: '#a78bfa' },
  gold: { id: 'gold', name: 'é‡‘(Gold)', return: 5.0, risk: 15.0, color: '#fcd34d' },
  cash: { id: 'cash', name: 'ç¾é‡‘', return: 0.01, risk: 0.0, color: '#9ca3af' },
};

const CORRELATION_MATRIX = {
  domestic_stock: { domestic_stock: 1.0, us_stock: 0.6, ex_us_stock: 0.7, emerging_stock: 0.6, domestic_bond: -0.1, us_agg_bond: 0.2, reit: 0.5, gold: 0.1, cash: 0.0 },
  us_stock:       { domestic_stock: 0.6, us_stock: 1.0, ex_us_stock: 0.9, emerging_stock: 0.7, domestic_bond: -0.2, us_agg_bond: 0.3, reit: 0.6, gold: 0.1, cash: 0.0 },
  ex_us_stock:    { domestic_stock: 0.7, us_stock: 0.9, ex_us_stock: 1.0, emerging_stock: 0.8, domestic_bond: -0.1, us_agg_bond: 0.5, reit: 0.6, gold: 0.2, cash: 0.0 },
  emerging_stock: { domestic_stock: 0.6, us_stock: 0.7, ex_us_stock: 0.8, emerging_stock: 1.0, domestic_bond: -0.1, us_agg_bond: 0.4, reit: 0.5, gold: 0.3, cash: 0.0 },
  domestic_bond:  { domestic_stock: -0.1, us_stock: -0.2, ex_us_stock: -0.1, emerging_stock: -0.1, domestic_bond: 1.0, us_agg_bond: 0.3, reit: 0.1, gold: 0.2, cash: 0.0 },
  us_agg_bond:    { domestic_stock: 0.2, us_stock: 0.3, ex_us_stock: 0.5, emerging_stock: 0.4, domestic_bond: 0.3, us_agg_bond: 1.0, reit: 0.3, gold: 0.3, cash: 0.0 },
  reit:           { domestic_stock: 0.5, us_stock: 0.6, ex_us_stock: 0.6, emerging_stock: 0.5, domestic_bond: 0.1, us_agg_bond: 0.3, reit: 1.0, gold: 0.2, cash: 0.0 },
  gold:           { domestic_stock: 0.1, us_stock: 0.1, ex_us_stock: 0.2, emerging_stock: 0.3, domestic_bond: 0.2, us_agg_bond: 0.3, reit: 0.2, gold: 1.0, cash: 0.0 },
  cash:           { domestic_stock: 0.0, us_stock: 0.0, ex_us_stock: 0.0, emerging_stock: 0.0, domestic_bond: 0.0, foreign_bond: 0.0, reit: 0.0, gold: 0.0, cash: 1.0 },
};

// --- Utility: Helper Functions ---
const formatPercent = (val, digits = 2) => {
  if (val === undefined || val === null || isNaN(val)) return '-';
  return val.toFixed(digits) + '%';
};

const formatCurrency = (val) => {
  if (val === undefined || val === null || isNaN(val)) return '-';
  return Math.round(val).toLocaleString();
};

const formatOku = (val) => {
    if (val === undefined || val === null || isNaN(val)) return '-';
    if (Math.abs(val) >= 10000) {
        return (val / 10000).toFixed(2) + 'å„„å††';
    }
    return Math.round(val).toLocaleString() + 'ä¸‡å††';
};

// --- Utility: LocalStorage Hook ---
const usePersistState = (key, defaultValue) => {
  const [state, setState] = useState(() => {
    try {
      // Version key (lps_v30_) for new version with Tax/NISA
      const saved = localStorage.getItem('lps_v30_' + key); 
      if (saved !== null) {
        return JSON.parse(saved);
      }
    } catch (e) {
      console.error('LocalStorage load error', e);
    }
    return defaultValue;
  });

  useEffect(() => {
    try {
      localStorage.setItem('lps_v30_' + key, JSON.stringify(state));
    } catch (e) {
      console.error('LocalStorage save error', e);
    }
  }, [key, state]);

  return [state, setState];
};

// æ­£è¦åˆ†å¸ƒä¹±æ•°ç”Ÿæˆ
const randn_bm = () => {
  let u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
};

const calculateAge = (birthDateString) => {
    if (!birthDateString) return 0;
    const today = new Date();
    const birthDate = new Date(birthDateString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
};

// æŠ•è³‡æŒ‡æ¨™è¨ˆç®—ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const calculateMetrics = (returns, finalBalance) => {
  const n = returns.length;
  if (n === 0) return { twr: 0, amr: 0, vol: 0, sharpe: 0, mdd: 0, final: finalBalance };

  const product = returns.reduce((acc, r) => acc * (1 + r), 1.0);
  const twr = Math.pow(product, 1 / n) - 1;

  const sum = returns.reduce((acc, r) => acc + r, 0);
  const amr = sum / n;

  const variance = returns.reduce((acc, r) => acc + Math.pow(r - amr, 2), 0) / (n - 1 || 1);
  const vol = Math.sqrt(variance);

  const sharpe = vol === 0 ? 0 : amr / vol;

  let peak = 1.0;
  let maxDrawdown = 0;
  let currentWealth = 1.0;

  for (const r of returns) {
    currentWealth *= (1 + r);
    if (currentWealth > peak) {
      peak = currentWealth;
    }
    const drawdown = (peak - currentWealth) / peak;
    if (drawdown > maxDrawdown) {
      maxDrawdown = drawdown;
    }
  }

  return {
    twr: twr * 100,
    amr: amr * 100,
    vol: vol * 100,
    sharpe: sharpe,
    mdd: maxDrawdown * 100,
    final: finalBalance 
  };
};

// ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè¨ˆç®—ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const calculatePortfolioStats = (allocation) => {
  let totalReturn = 0;
  let totalVariance = 0;
  const assets = Object.keys(allocation);

  assets.forEach(id => {
    const weight = allocation[id] / 100;
    const asset = ASSET_CLASSES[id];
    if (asset) {
        totalReturn += weight * asset.return;
    }
  });

  for (let i = 0; i < assets.length; i++) {
    for (let j = 0; j < assets.length; j++) {
      const id_i = assets[i];
      const id_j = assets[j];
      const asset_i = ASSET_CLASSES[id_i];
      const asset_j = ASSET_CLASSES[id_j];
      
      if (asset_i && asset_j) {
        const w_i = allocation[id_i] / 100;
        const w_j = allocation[id_j] / 100;
        const sigma_i = asset_i.risk;
        const sigma_j = asset_j.risk;
        const rho = CORRELATION_MATRIX[id_i] && CORRELATION_MATRIX[id_i][id_j] !== undefined ? CORRELATION_MATRIX[id_i][id_j] : 0;
        
        totalVariance += w_i * w_j * sigma_i * sigma_j * rho;
      }
    }
  }

  return {
    return: totalReturn,
    risk: Math.sqrt(totalVariance)
  };
};

// ä½å®…ãƒ­ãƒ¼ãƒ³è¨ˆç®—
const calculateMonthlyMortgage = (balanceMan, years, ratePercent) => {
  if (balanceMan <= 0 || years <= 0) return 0;
  const principal = balanceMan * 10000;
  if (ratePercent <= 0) return Math.round(principal / (years * 12));
  const r = ratePercent / 100 / 12;
  const n = years * 12;
  const numerator = principal * r * Math.pow(1 + r, n);
  const denominator = Math.pow(1 + r, n) - 1;
  return Math.round(numerator / denominator);
};

// æ•™è‚²è²»çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
const EDUCATION_COSTS = {
  nursery: { public: 25, private: 50 },
  elementary: { public: 35, private: 160 },
  middle: { public: 54, private: 144 },
  high: { public: 51, private: 105 },
  university: { national: 82, private_hum: 120, private_sci: 160, none: 0 }
};

// å¡¾ãƒ»ç¿’ã„äº‹è²»ç”¨
const CRAM_SCHOOL_COSTS = {
  elementary_low: 20,
  elementary_high: 40,
  middle: 40,
  middle_exam: 60,
  high: 50,
  high_exam: 70
};

const getCramCost = (age) => {
  if (age >= 6 && age <= 8) return CRAM_SCHOOL_COSTS.elementary_low;
  if (age >= 9 && age <= 11) return CRAM_SCHOOL_COSTS.elementary_high;
  if (age >= 12 && age <= 13) return CRAM_SCHOOL_COSTS.middle;
  if (age === 14) return CRAM_SCHOOL_COSTS.middle_exam;
  if (age >= 15 && age <= 16) return CRAM_SCHOOL_COSTS.high;
  if (age === 17) return CRAM_SCHOOL_COSTS.high_exam;
  return 0;
};

// Asset Info Modal Component
const AssetInfoModal = ({ onClose }) => {
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-xl p-6 max-w-4xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">ğŸ“Š ã‚¢ã‚»ãƒƒãƒˆè©³ç´°ãƒ»ç›¸é–¢è¡¨</h3>
            <button onClick={onClose} className="p-1 hover:bg-slate-100 rounded"><X size={20}/></button>
        </div>
        
        <div className="mb-6">
            <h4 className="font-bold text-sm text-slate-600 mb-2">è¨­å®šãƒªã‚¿ãƒ¼ãƒ³ãƒ»ãƒªã‚¹ã‚¯ (å¹´ç‡)</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                {Object.values(ASSET_CLASSES).map(asset => (
                    <div key={asset.id} className="p-3 rounded border border-slate-200 bg-slate-50 text-xs">
                        <div className="flex items-center gap-2 mb-1">
                            <div className="w-2 h-2 rounded-full" style={{backgroundColor: asset.color}}></div>
                            <span className="font-bold">{asset.name}</span>
                        </div>
                        <div className="flex justify-between"><span>ãƒªã‚¿ãƒ¼ãƒ³:</span> <span>{asset.return}%</span></div>
                        <div className="flex justify-between"><span>ãƒªã‚¹ã‚¯:</span> <span>{asset.risk}%</span></div>
                    </div>
                ))}
            </div>
        </div>

        <div>
            <h4 className="font-bold text-sm text-slate-600 mb-2">ç›¸é–¢ä¿‚æ•°è¡Œåˆ—</h4>
            <div className="overflow-x-auto">
                <table className="w-full text-[10px] md:text-xs text-center border-collapse">
                    <thead>
                        <tr>
                            <th className="p-1 bg-slate-100 border"></th>
                            {Object.values(ASSET_CLASSES).map(a => <th key={a.id} className="p-1 bg-slate-100 border font-normal">{a.name}</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {Object.keys(CORRELATION_MATRIX).map(rowId => (
                            <tr key={rowId}>
                                <td className="p-1 bg-slate-100 border font-normal text-left whitespace-nowrap">{ASSET_CLASSES[rowId].name}</td>
                                {Object.keys(CORRELATION_MATRIX[rowId]).map(colId => {
                                    const val = CORRELATION_MATRIX[rowId][colId];
                                    let bg = 'bg-white';
                                    if (val > 0.7) bg = 'bg-red-100';
                                    else if (val > 0.4) bg = 'bg-red-50';
                                    else if (val < 0) bg = 'bg-blue-50';
                                    return <td key={colId} className={`p-1 border ${bg}`}>{val.toFixed(2)}</td>
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </div>
  );
};

// Education Cost Info Modal
const EducationCostModal = ({ onClose }) => {
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div className="bg-white rounded-xl p-6 max-w-3xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">ğŸ“ æ•™è‚²è²»ãƒ»ç¿’ã„äº‹è²»ç”¨ã®å†…è¨³</h3>
              <button onClick={onClose} className="p-1 hover:bg-slate-100 rounded"><X size={20}/></button>
          </div>
          
          <div className="space-y-6">
            <div>
                <h4 className="font-bold text-sm text-indigo-700 mb-2 border-b pb-1 flex items-center gap-2"><BookOpen size={16}/> å­¦æ ¡ç¨®åˆ¥ã”ã¨ã®å¹´é–“å­¦è²» (æ¦‚ç®—)</h4>
                <p className="text-xs text-slate-500 mb-2">â€»æ–‡éƒ¨ç§‘å­¦çœã€Œå­ä¾›ã®å­¦ç¿’è²»èª¿æŸ»ã€ãªã©ã‚’å‚è€ƒã«ã—ãŸã€æˆæ¥­æ–™ãƒ»çµ¦é£Ÿè²»ãƒ»å­¦æ ¡ç´ä»˜é‡‘ãƒ»é€šå­¦è²»ç­‰ã®ç›®å®‰ï¼ˆå¹´é¡ãƒ»ä¸‡å††ï¼‰ã€‚</p>
                <div className="overflow-x-auto">
                    <table className="w-full text-xs text-left border-collapse border border-slate-200">
                        <thead className="bg-slate-100">
                            <tr>
                                <th className="p-2 border border-slate-200">åŒºåˆ†</th>
                                <th className="p-2 border border-slate-200">å…¬ç«‹ / å›½ç«‹</th>
                                <th className="p-2 border border-slate-200">ç§ç«‹</th>
                                <th className="p-2 border border-slate-200">å‚™è€ƒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td className="p-2 border border-slate-200 font-bold">å¹¼ç¨šåœ’ãƒ»ä¿è‚²åœ’</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.nursery.public} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.nursery.private} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200 text-slate-500">å¹¼ä¿ç„¡å„ŸåŒ–å¾Œã®é›‘è²»ç­‰æƒ³å®š</td>
                            </tr>
                            <tr>
                                <td className="p-2 border border-slate-200 font-bold">å°å­¦æ ¡</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.elementary.public} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.elementary.private} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200 text-slate-500"></td>
                            </tr>
                            <tr>
                                <td className="p-2 border border-slate-200 font-bold">ä¸­å­¦æ ¡</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.middle.public} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.middle.private} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200 text-slate-500"></td>
                            </tr>
                            <tr>
                                <td className="p-2 border border-slate-200 font-bold">é«˜æ ¡</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.high.public} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.high.private} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200 text-slate-500"></td>
                            </tr>
                            <tr>
                                <td className="p-2 border border-slate-200 font-bold">å¤§å­¦</td>
                                <td className="p-2 border border-slate-200">{EDUCATION_COSTS.university.national} ä¸‡å††</td>
                                <td className="p-2 border border-slate-200">
                                    æ–‡ç³»: {EDUCATION_COSTS.university.private_hum} ä¸‡å††<br/>
                                    ç†ç³»: {EDUCATION_COSTS.university.private_sci} ä¸‡å††
                                </td>
                                <td className="p-2 border border-slate-200 text-slate-500">å­¦è²»ï¼‹ç”Ÿæ´»è²»è£œåŠ©ã®ä¸€éƒ¨ã‚’å«ã‚€æ¦‚ç®—</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
  
            <div>
                <h4 className="font-bold text-sm text-indigo-700 mb-2 border-b pb-1 flex items-center gap-2"><GraduationCap size={16}/> å¡¾ãƒ»ç¿’ã„äº‹è²»ç”¨ (æ¦‚ç®—)</h4>
                <p className="text-xs text-slate-500 mb-2">â€»è¨­å®šã—ãŸã€Œé–‹å§‹å¹´é½¢ã€œçµ‚äº†å¹´é½¢ã€ã®é–“ã€æ¯å¹´åŠ ç®—ã•ã‚Œã‚‹è²»ç”¨ï¼ˆå¹´é¡ãƒ»ä¸‡å††ï¼‰ã€‚</p>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">å°å­¦æ ¡ ä½å­¦å¹´ (ç¿’ã„äº‹ç­‰)</span>
                        <span className="text-lg">{CRAM_SCHOOL_COSTS.elementary_low}</span> ä¸‡å††/å¹´
                    </div>
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">å°å­¦æ ¡ é«˜å­¦å¹´ (å¡¾ç­‰)</span>
                        <span className="text-lg">{CRAM_SCHOOL_COSTS.elementary_high}</span> ä¸‡å††/å¹´
                    </div>
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">ä¸­å­¦æ ¡ (1ã€œ2å¹´)</span>
                        <span className="text-lg">{CRAM_SCHOOL_COSTS.middle}</span> ä¸‡å††/å¹´
                    </div>
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">ä¸­å­¦æ ¡ (3å¹´/å—é¨“)</span>
                        <span className="text-lg text-red-600">{CRAM_SCHOOL_COSTS.middle_exam}</span> ä¸‡å††/å¹´
                    </div>
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">é«˜æ ¡ (1ã€œ2å¹´)</span>
                        <span className="text-lg">{CRAM_SCHOOL_COSTS.high}</span> ä¸‡å††/å¹´
                    </div>
                    <div className="bg-slate-50 p-2 rounded border border-slate-200 text-xs">
                        <span className="font-bold block mb-1">é«˜æ ¡ (3å¹´/äºˆå‚™æ ¡ç­‰)</span>
                        <span className="text-lg text-red-600">{CRAM_SCHOOL_COSTS.high_exam}</span> ä¸‡å††/å¹´
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

const ScenarioCard = ({ title, color, data, lifeExpectancy, isMain }) => {
    if (!data) return null;
    const isDepleted = data.depletionAge !== null;
    const resultColor = isDepleted ? 'text-red-600' : 'text-slate-800';
    const borderColor = color === 'blue' ? 'border-blue-200' : color === 'indigo' ? 'border-indigo-200' : 'border-green-200';
    const bgColor = color === 'blue' ? 'bg-blue-50' : color === 'indigo' ? 'bg-indigo-50' : 'bg-green-50';
    const textColor = color === 'blue' ? 'text-blue-800' : color === 'indigo' ? 'text-indigo-800' : 'text-green-800';

    return (
        <div className={`rounded-xl border ${borderColor} ${isMain ? 'ring-2 ring-indigo-300 shadow-md' : 'shadow-sm'} bg-white overflow-hidden flex flex-col`}>
            <div className={`${bgColor} px-4 py-3 border-b ${borderColor} flex justify-between items-center`}>
                <h3 className={`font-bold text-sm ${textColor}`}>{title}</h3>
                {isMain && <span className="text-[10px] bg-indigo-200 text-indigo-800 px-2 py-0.5 rounded-full font-bold">Standard</span>}
            </div>
            <div className="p-4 flex-1 flex flex-col justify-between space-y-4">
                <div className="text-center">
                    <p className="text-xs text-slate-500 mb-1">æœ€çµ‚çµæœ ({lifeExpectancy}æ­³)</p>
                    <div className={`text-2xl font-bold ${resultColor}`}>
                        {isDepleted ? (
                            <span className="flex items-center justify-center gap-2"><AlertTriangle size={24}/> {data.depletionAge}æ­³ã§æ¯æ¸‡</span>
                        ) : (
                            <span className="flex items-center justify-center gap-2"><Flag size={24} className="text-green-500"/> {formatOku(data.final)}</span>
                        )}
                    </div>
                </div>
                
                <div className="grid grid-cols-2 gap-y-3 gap-x-2 text-xs border-t pt-3">
                    <div>
                        <span className="block text-slate-400">å¹´å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³</span>
                        <span className="font-bold text-slate-700 text-sm">{formatPercent(data.twr)}</span>
                    </div>
                    <div>
                        <span className="block text-slate-400">ãƒªã‚¹ã‚¯ (Vol)</span>
                        <span className="font-bold text-slate-700 text-sm">{formatPercent(data.vol)}</span>
                    </div>
                    <div>
                        <span className="block text-slate-400">ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª</span>
                        <span className="font-bold text-slate-700 text-sm">{data.sharpe ? data.sharpe.toFixed(2) : '-'}</span>
                    </div>
                    <div>
                        <span className="block text-slate-400">æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³</span>
                        <span className="font-bold text-red-500 text-sm">{formatPercent(data.mdd)}</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default function App() {
  // --- State Definitions ---

  // æœ¬äººæƒ…å ±
  const [userBirthDate, setUserBirthDate] = usePersistState('userBirthDate', '1981-06-21');
  const currentAge = useMemo(() => calculateAge(userBirthDate), [userBirthDate]);

  const [retirementAge, setRetirementAge] = usePersistState('retirementAge', 48);
  const [retirementIncome, setRetirementIncome] = usePersistState('retirementIncome', 500);
  const [pensionStartAge, setPensionStartAge] = usePersistState('pensionStartAge', 60);
  const [lifeExpectancy, setLifeExpectancy] = usePersistState('lifeExpectancy', 95);
  const [yearlyIncome, setYearlyIncome] = usePersistState('yearlyIncome', 1000);
  const [pension, setPension] = usePersistState('pension', 150);
  
  // é…å¶è€…æƒ…å ±
  const [hasSpouse, setHasSpouse] = usePersistState('hasSpouse', true);
  const [spouseBirthDate, setSpouseBirthDate] = usePersistState('spouseBirthDate', '1981-09-16');
  const spouseAge = useMemo(() => calculateAge(spouseBirthDate), [spouseBirthDate]);

  const [spouseRetirementAge, setSpouseRetirementAge] = usePersistState('spouseRetirementAge', 60);
  const [spouseRetirementIncome, setSpouseRetirementIncome] = usePersistState('spouseRetirementIncome', 2000);
  const [spousePensionStartAge, setSpousePensionStartAge] = usePersistState('spousePensionStartAge', 60);
  const [spouseIncome, setSpouseIncome] = usePersistState('spouseIncome', 580);
  const [spousePension, setSpousePension] = usePersistState('spousePension', 150);

  // å­ä¾›æƒ…å ±
  const [children, setChildren] = usePersistState('children_v2', [
    { id: 1, birthDate: '2012-07-14', edu: { elementary: 'public', middle: 'public', high: 'public', university: 'private_hum' }, cram: { start: 13, end: 18 } },
    { id: 2, birthDate: '2014-10-12', edu: { elementary: 'public', middle: 'public', high: 'public', university: 'private_hum' }, cram: { start: 11, end: 18 } }
  ]);
  
  // è³‡ç”£ãƒ»é‹ç”¨ãƒ»ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª
  const [initialCash, setInitialCash] = usePersistState('initialCash', 631);
  // Separate Asset Inputs
  const [initialNisaBalance, setInitialNisaBalance] = usePersistState('initialNisaBalance', 4475);
  const [initialTaxableBalance, setInitialTaxableBalance] = usePersistState('initialTaxableBalance', 8294);
  const [initialTaxablePrincipal, setInitialTaxablePrincipal] = usePersistState('initialTaxablePrincipal', 3414); // æ¦‚ç®—å…ƒæœ¬
  
  const [currentPortfolio, setCurrentPortfolio] = usePersistState('currentPortfolio', {
    domestic_stock: 0, us_stock: 72, ex_us_stock: 10, emerging_stock: 5, domestic_bond: 0, us_agg_bond: 5, reit: 0, gold: 8
  });
  const [targetPortfolio, setTargetPortfolio] = usePersistState('targetPortfolio', {
    domestic_stock: 0, us_stock: 50, ex_us_stock: 10, emerging_stock: 0, domestic_bond: 0, us_agg_bond: 20, reit: 0, gold: 20
  });
  const [glidePathYears, setGlidePathYears] = usePersistState('glidePathYears', 1);

  const [incomeGrowth, setIncomeGrowth] = usePersistState('incomeGrowth', 2.0);
  const [inflationRate, setInflationRate] = usePersistState('inflationRate', 2.0);
  const [macroSlide, setMacroSlide] = usePersistState('macroSlide', 0.9);
  
  const [expectedReturn, setExpectedReturn] = usePersistState('expectedReturn', 10.0);
  const [risk, setRisk] = usePersistState('risk', 15.0);
  
  const [simulationCount, setSimulationCount] = useState(500);

  // ç©ç«‹ãƒ»å–ã‚Šå´©ã—ãƒ»ç¨é‡‘è¨­å®š
  const [annualInvestment, setAnnualInvestment] = usePersistState('annualInvestment', 300);
  const [investAfterRetirement, setInvestAfterRetirement] = usePersistState('investAfterRetirement', false);
  const [targetCashAtRetirement, setTargetCashAtRetirement] = usePersistState('targetCashAtRetirement', 3000); 
  
  // NISA & Tax Settings
  const [nisaLifetimeLimit, setNisaLifetimeLimit] = usePersistState('nisaLifetimeLimit', 2160); // ä¸‡
  const [investPriority, setInvestPriority] = usePersistState('investPriority', 'nisa'); // 'nisa' | 'taxable'
  const [withdrawalPriority, setWithdrawalPriority] = usePersistState('withdrawalPriority', 'taxable'); // 'nisa' | 'taxable'
  const [withdrawalAmountType, setWithdrawalAmountType] = usePersistState('withdrawalAmountType', 'net'); // 'net' (æ‰‹å–ã‚Š) | 'gross' (é¡é¢)
  const [taxRate, setTaxRate] = usePersistState('taxRate', 20.315);

  const [withdrawalType, setWithdrawalType] = usePersistState('withdrawalType', 'fixed_rate');
  const [withdrawalValue, setWithdrawalValue] = usePersistState('withdrawalValue', 4.0);
  const [withdrawalStrategy, setWithdrawalStrategy] = usePersistState('withdrawalStrategy', 'skip_negative');
  const [skipNegativeYearsLimit, setSkipNegativeYearsLimit] = usePersistState('skipNegativeYearsLimit', 5);
  const [maxCashReserve, setMaxCashReserve] = usePersistState('maxCashReserve', 5000);

  // ä½å±…ãƒ»ãƒ­ãƒ¼ãƒ³
  const [housingType, setHousingType] = usePersistState('housingType', 'owned');
  const [mortgageBalance, setMortgageBalance] = usePersistState('mortgageBalance', 2300);
  const [mortgageYears, setMortgageYears] = usePersistState('mortgageYears', 20);
  const [mortgageRate, setMortgageRate] = usePersistState('mortgageRate', 0.78);
  
  // æ”¯å‡ºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ
  const [monthlyExpense, setMonthlyExpense] = usePersistState('monthlyExpense', 65);
  const [housingExpense, setHousingExpense] = usePersistState('housingExpense', 0);
  const [postRetirementExpenseRatio, setPostRetirementExpenseRatio] = usePersistState('postRetirementExpenseRatio', 100); 
  const [spendingPattern, setSpendingPattern] = usePersistState('spendingPattern', 'ushape');
  const [expenseDecayRate, setExpenseDecayRate] = usePersistState('expenseDecayRate', 0.5);
  const [ushapePhase1Ratio, setUshapePhase1Ratio] = usePersistState('ushapePhase1Ratio', 85); // 75-84æ­³
  const [ushapePhase2Ratio, setUshapePhase2Ratio] = usePersistState('ushapePhase2Ratio', 95); // 85æ­³-
  
  const [events, setEvents] = usePersistState('events_v5', [
    { id: 1, name: 'è»Šè²·ã„æ›¿ãˆ', amount: 800, type: 'expense', isRecurring: false, startAge: 49, endAge: 49, useInflation: true, assetThreshold: 0 },
    { id: 2, name: 'è»Šè²·ã„æ›¿ãˆ', amount: 250, type: 'expense', isRecurring: false, startAge: 50, endAge: 50, useInflation: true, assetThreshold: 0 },
    { id: 3, name: 'è»Šè²·ã„æ›¿ãˆ', amount: 1000, type: 'expense', isRecurring: false, startAge: 59, endAge: 59, useInflation: true, assetThreshold: 0 },
    { id: 4, name: 'è»Šè²·ã„æ›¿ãˆ', amount: 300, type: 'expense', isRecurring: false, startAge: 60, endAge: 60, useInflation: true, assetThreshold: 0 },
    { id: 5, name: 'åˆ†å‰²è´ˆä¸', amount: 210, type: 'income', isRecurring: true, startAge: 45, endAge: 60, useInflation: false, assetThreshold: 0 },
    { id: 6, name: 'è´ˆä¸', amount: 220, type: 'expense', isRecurring: true, startAge: 60, endAge: 95, useInflation: false, assetThreshold: 10000 },
  ]);
  const [newEvent, setNewEvent] = useState({ name: '', amount: 100, type: 'expense', isRecurring: false, startAge: 50, endAge: 55, useInflation: true, assetThreshold: 0 });

  // UI State
  const [simulationData, setSimulationData] = useState([]);
  const [stats, setStats] = useState({ minP10: 0, finalP50: 0, negativeAge: null, successRate: 0, assetAtRetirement: 0, depletionRates: {} });
  const [summaryMetrics, setSummaryMetrics] = useState({ pessimistic: {}, central: {}, optimistic: {} });
  const [isCalculating, setIsCalculating] = useState(false);
  const [showTable, setShowTable] = useState(false);
  const [activeScenarioTab, setActiveScenarioTab] = useState('central'); 
  const [breakdownScenario, setBreakdownScenario] = useState('p50');
  const [chartMode, setChartMode] = useState('final_year'); 
  const [showPortfolioModal, setShowPortfolioModal] = useState(false);
  const [showAssetInfo, setShowAssetInfo] = useState(false);
  const [showEducationInfo, setShowEducationInfo] = useState(false);
  const [isTableMaximized, setIsTableMaximized] = useState(false);

  // AI State
  const [aiAdvice, setAiAdvice] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);

  // --- Helper Functions for Logic ---
  const resetSettings = () => { if(window.confirm('ã™ã¹ã¦ã®è¨­å®šã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); window.location.reload(); }};
  const getEducationExpense = useCallback((age, eduPath, cram) => {
    let eduCost = 0;
    if (age >= 3 && age <= 5) eduCost = EDUCATION_COSTS.nursery.public;
    else if (age >= 6 && age <= 11) eduCost = eduPath.elementary === 'private' ? EDUCATION_COSTS.elementary.private : EDUCATION_COSTS.elementary.public;
    else if (age >= 12 && age <= 14) eduCost = eduPath.middle === 'private' ? EDUCATION_COSTS.middle.private : EDUCATION_COSTS.middle.public;
    else if (age >= 15 && age <= 17) eduCost = eduPath.high === 'private' ? EDUCATION_COSTS.high.private : EDUCATION_COSTS.high.public;
    else if (age >= 18 && age <= 21) {
      switch (eduPath.university) {
        case 'national': eduCost = EDUCATION_COSTS.university.national; break;
        case 'private_hum': eduCost = EDUCATION_COSTS.university.private_hum; break;
        case 'private_sci': eduCost = EDUCATION_COSTS.university.private_sci; break;
        case 'none': eduCost = 0; break;
        default: eduCost = EDUCATION_COSTS.university.private_hum;
      }
    }
    let cramCost = 0;
    if (age >= cram.start && age <= cram.end) cramCost = getCramCost(age);
    return eduCost + cramCost;
  }, []);

  const addChild = () => setChildren([...children, { id: Date.now(), birthDate: '2020-01-01', edu: { elementary: 'public', middle: 'public', high: 'public', university: 'private_hum' }, cram: { start: 10, end: 18 } }]);
  const removeChild = (id) => setChildren(children.filter(c => c.id !== id));
  const updateChildBirthDate = (index, val) => { const n = [...children]; n[index].birthDate = val; setChildren(n); };
  const updateChildEdu = (index, stage, val) => { const n = [...children]; n[index].edu[stage] = val; setChildren(n); };
  const updateChildCram = (index, field, val) => { const n = [...children]; n[index].cram[field] = Number(val); setChildren(n); };
  const addEvent = () => { if (!newEvent.name) return; setEvents([...events, { ...newEvent, id: Date.now() }].sort((a, b) => a.startAge - b.startAge)); setNewEvent({ ...newEvent, name: '', amount: 100, useInflation: true, assetThreshold: 0 }); };
  const removeEvent = (id) => setEvents(events.filter(e => e.id !== id));

  const updatePortfolio = (type, id, value) => {
    const val = Math.max(0, Math.min(100, Number(value)));
    if (type === 'current') setCurrentPortfolio(prev => ({ ...prev, [id]: val }));
    else setTargetPortfolio(prev => ({ ...prev, [id]: val }));
  };

  const applyPortfolioStats = () => {
    const stats = calculatePortfolioStats(currentPortfolio);
    setExpectedReturn(Number(stats.return.toFixed(2)));
    setRisk(Number(stats.risk.toFixed(2)));
    setShowPortfolioModal(false);
  };

  const portfolioTotal = Object.keys(ASSET_CLASSES).reduce((sum, key) => sum + (currentPortfolio[key] || 0), 0);
  const currentStats = useMemo(() => calculatePortfolioStats(currentPortfolio), [currentPortfolio]);
  const targetStats = useMemo(() => calculatePortfolioStats(targetPortfolio), [targetPortfolio]);

  // AI
  const generateAiAdvice = async () => {
    setIsAiLoading(true);
    setAiAdvice('');
    const householdIncome = yearlyIncome + (hasSpouse ? spouseIncome : 0);
    const totalAssets = initialCash + initialNisaBalance + initialTaxableBalance;
    const childrenInfo = children.map((c, i) => `ç¬¬${i+1}å­(${calculateAge(c.birthDate)}æ­³)`).join(', ');
    
    const prompt = `
      ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚
      ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«åŸºã¥ãã€ä»¥ä¸‹ã®3ç‚¹ã«ã¤ã„ã¦è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
      ç‰¹ã«ã€ã€Œã‚ãªãŸãŒè¨­å®šã—ãŸ${retirementAge}æ­³ã§ã®å¼•é€€ã€ã¨ã„ã†ç›®æ¨™ã«å¯¾ã—ã¦ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœï¼ˆæˆåŠŸç‡${stats.successRate.toFixed(1)}%ï¼‰ãŒã©ã†ãªã®ã‹ã€ã¨ã„ã†è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
      
      1. **ç¾çŠ¶ã®è¨ºæ–­**: è¨­å®šã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã®å®‰å…¨æ€§è©•ä¾¡ã€‚
      2. **ãƒªã‚¹ã‚¯ã¸ã®å‚™ãˆ**: æ‚²è¦³ã‚·ãƒŠãƒªã‚ªï¼ˆå¸‚å ´æš´è½ã‚„ã‚¤ãƒ³ãƒ•ãƒ¬ï¼‰ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ãªå¿ƒæ§‹ãˆã‚„å¯¾ç­–ãŒå¿…è¦ã‹ã€‚
      3. **å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: è³‡ç”£å¯¿å‘½ã‚’å»¶ã°ã™ã€ã‚ã‚‹ã„ã¯ã‚ˆã‚Šè±Šã‹ã«æš®ã‚‰ã™ãŸã‚ã®å…·ä½“çš„ãªææ¡ˆï¼ˆç©ç«‹é¡ã®èª¿æ•´ã€æ”¯å‡ºã®è¦‹ç›´ã—ã€åƒãæ–¹ãªã©ï¼‰ã€‚

      ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
      - ç¾åœ¨å¹´é½¢: ${currentAge}æ­³
      - ä¸–å¸¯å¹´å: ${householdIncome}ä¸‡å††
      - ç¾åœ¨è³‡ç”£: ${totalAssets}ä¸‡å†† (ç¾é‡‘:${initialCash}ä¸‡, NISA:${initialNisaBalance}ä¸‡, ç‰¹å®š:${initialTaxableBalance}ä¸‡)
      - å¼•é€€äºˆå®š: ${retirementAge}æ­³
      - å®¶æ—æ§‹æˆ: ${hasSpouse ? `é…å¶è€…(${spouseAge}æ­³)` : 'é…å¶è€…ãªã—'}, å­ä¾›: ${childrenInfo || 'ãªã—'}

      ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã€‘
      - é‹ç”¨ãƒªã‚¿ãƒ¼ãƒ³(å¹´ç‡): ${expectedReturn}%
      - ã‚¤ãƒ³ãƒ•ãƒ¬ç‡(å¹´ç‡): ${inflationRate}%
      - å–ã‚Šå´©ã—è¨­å®š: ${withdrawalType === 'none' ? 'ãªã—' : withdrawalType} (æ‰‹å–ã‚Šç¢ºä¿: ${withdrawalAmountType === 'net' ? 'ã‚ã‚Š' : 'ãªã—'})

      ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã€‘
      - ${lifeExpectancy}æ­³ã¾ã§ã®è³‡ç”£ç¶­æŒæˆåŠŸç‡: ${stats.successRate.toFixed(1)}%
      - æ‚²è¦³ã‚·ãƒŠãƒªã‚ª(ä¸‹ä½10%)ã§ã®æ¯æ¸‡å¹´é½¢: ${stats.minP10 < 0 ? stats.negativeAge + 'æ­³' : 'æ¯æ¸‡ãªã—'}
      - å¼•é€€æ™‚ã®è³‡ç”£(ä¸­å¤®å€¤): ${Math.round(stats.assetAtRetirement / 10000)}å„„å††
      - ${lifeExpectancy}æ­³æ™‚ç‚¹ã®è³‡ç”£(ä¸­å¤®å€¤): ${Math.round(stats.finalP50 / 10000)}å„„å††
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      const data = await response.json();
      setAiAdvice(data.candidates?.[0]?.content?.parts?.[0]?.text || "ç”Ÿæˆå¤±æ•—");
    } catch (e) { setAiAdvice("ã‚¨ãƒ©ãƒ¼"); } finally { setIsAiLoading(false); }
  };

  const estimatedMonthlyMortgage = useMemo(() => calculateMonthlyMortgage(mortgageBalance, mortgageYears, mortgageRate), [mortgageBalance, mortgageYears, mortgageRate]);

  // --- Main Simulation Logic ---
  const runMonteCarloSimulation = useCallback(() => {
    const duration = lifeExpectancy - currentAge + 1;
    if (duration <= 0) return;
    
    // --- æ—¥å‰²ã‚Šè¨ˆç®—ç”¨ä¿‚æ•° (åˆå¹´åº¦ã®ã¿) ---
    const today = new Date();
    const currentYear = today.getFullYear();
    const isLeap = (currentYear % 4 === 0 && (currentYear % 100 !== 0 || currentYear % 400 === 0));
    const daysInYear = isLeap ? 366 : 365;
    const todayNoon = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 12, 0, 0);
    const endYearNoon = new Date(currentYear, 11, 31, 12, 0, 0);
    const daysRemaining = Math.max(0, Math.round((endYearNoon - todayNoon) / (1000 * 60 * 60 * 24))) + 1;
    const firstYearFraction = Math.max(0, Math.min(1, daysRemaining / daysInYear));
    // -----------------------------------

    const yearlyStats = [];
    for (let i = 0; i < duration; i++) {
        const progress = glidePathYears > 0 ? Math.min(1, i / glidePathYears) : 0;
        const allocation = {};
        Object.keys(ASSET_CLASSES).forEach(key => {
            const start = currentPortfolio[key] || 0;
            const end = targetPortfolio[key] || 0;
            allocation[key] = start + (end - start) * progress;
        });
        yearlyStats.push(calculatePortfolioStats(allocation));
    }

    const monthlyMortgageMan = housingType === 'owned' ? calculateMonthlyMortgage(mortgageBalance, mortgageYears, mortgageRate) / 10000 : 0;
    const yearlyCashFlows = [];
    let currentUserIncome = yearlyIncome;
    let currentSpouseIncome = spouseIncome;

    for (let i = 0; i < duration; i++) {
        const age = currentAge + i;
        const inflationFactor = Math.pow(1 + inflationRate / 100, i);
        const fraction = (i === 0) ? firstYearFraction : 1.0; 
        
        let uIncRaw = (age < retirementAge) ? currentUserIncome * Math.pow(1 + incomeGrowth/100, i) : (age >= pensionStartAge ? pension * Math.pow(1+(inflationRate-macroSlide)/100, i) : 0);
        let uInc = uIncRaw * fraction;

        let sIncRaw = hasSpouse ? ((age < spouseRetirementAge) ? currentSpouseIncome * Math.pow(1 + incomeGrowth/100, i) : (age >= spousePensionStartAge ? spousePension * Math.pow(1+(inflationRate-macroSlide)/100, i) : 0)) : 0;
        let sInc = sIncRaw * fraction;

        let retInc = 0;
        if (age === retirementAge) retInc += retirementIncome;
        if (hasSpouse && age + (spouseAge - currentAge) === spouseRetirementAge) retInc += spouseRetirementIncome;

        let baseExp = monthlyExpense * 12 * inflationFactor; 
        if (age >= retirementAge) {
             let decayFactor = 1.0;
             if (spendingPattern === 'linear') {
                 decayFactor = Math.pow(1 - expenseDecayRate/100, age - retirementAge);
             } else if (spendingPattern === 'ushape') {
                 if (age >= 85) decayFactor = ushapePhase2Ratio / 100;
                 else if (age >= 75) decayFactor = ushapePhase1Ratio / 100;
                 else decayFactor = 1.0;
             }
             baseExp = baseExp * decayFactor * (postRetirementExpenseRatio / 100);
        }
        baseExp *= fraction;
        
        let houseCost = housingType === 'rent' ? housingExpense * 12 * inflationFactor : (i < mortgageYears ? monthlyMortgageMan * 12 : 0) + housingExpense * 12 * inflationFactor;
        houseCost *= fraction;
        
        let eventIncome = 0;
        let eventExpense = 0;
        const conditionalEvents = []; 

        events.forEach(e => {
            if (e.isRecurring ? (e.startAge <= age && age <= e.endAge) : e.startAge === age) {
                const shouldUseInflation = e.useInflation !== false;
                let val = shouldUseInflation ? e.amount * inflationFactor : e.amount;
                if (e.isRecurring && i === 0) val *= fraction;

                if (e.type === 'expense' && e.assetThreshold > 0) {
                    conditionalEvents.push({ ...e, amount: val, threshold: e.assetThreshold });
                } else {
                    if (e.type === 'income') eventIncome += val;
                    else eventExpense += val;
                }
            }
        });

        const eduCostTotal = children.reduce((sum, child) => sum + getEducationExpense(calculateAge(child.birthDate) + i, child.edu, child.cram) * inflationFactor, 0);
        const totalExpense = baseExp + houseCost + eventExpense + (eduCostTotal * fraction);

        const annualBalance = uInc + sInc + retInc - totalExpense + eventIncome;
        const totalIncome = uInc + sInc + retInc + eventIncome;

        let totalEducationCost = 0;
        children.forEach(child => {
            totalEducationCost += (getEducationExpense(calculateAge(child.birthDate) + i, child.edu, child.cram) * inflationFactor);
        });
        totalEducationCost *= fraction;

        let eventNames = age === retirementAge ? "é€€è·" : "";

        yearlyCashFlows.push({
            age,
            annualBalance: totalIncome - totalExpense, 
            eventNames,
            income: totalIncome,
            expense: totalExpense, 
            baseLivingCost: baseExp,
            housingCost: houseCost,
            eventExpense: eventExpense, 
            educationCost: totalEducationCost,
            conditionalEvents 
        });
    }

    const simCount = simulationCount;
    const simDataAtYear = Array.from({ length: duration }, () => []);
    let successCount = 0;

    for (let sim = 0; sim < simCount; sim++) {
        let cash = initialCash;
        let nisaBalance = initialNisaBalance;
        let taxableBalance = initialTaxableBalance;
        let taxablePrincipal = initialTaxablePrincipal;
        let remainingNisaLimit = nisaLifetimeLimit; // User input is remaining limit
        if (remainingNisaLimit < 0) remainingNisaLimit = 0;

        let neverDepleted = true;
        
        let fixedRetirementWithdrawalBase = 0;
        let retirementYearInflationFactor = 1.0;

        for (let i = 0; i < duration; i++) {
            const age = currentAge + i;
            
            // --- æ¡ä»¶ä»˜ãã‚¤ãƒ™ãƒ³ãƒˆ ---
            let executedConditionalExpense = 0;
            if (yearlyCashFlows[i].conditionalEvents) {
                yearlyCashFlows[i].conditionalEvents.forEach(evt => {
                    const totalAsset = cash + nisaBalance + taxableBalance;
                    if (totalAsset >= evt.threshold) {
                        executedConditionalExpense += evt.amount;
                    }
                });
            }

            let mu = expectedReturn;
            let sigma = risk;
            if (yearlyStats[i]) {
                mu = yearlyStats[i].return;
                sigma = yearlyStats[i].risk;
            }
            const monthlyMu = mu / 100 / 12;
            const monthlySigma = sigma / 100 / Math.sqrt(12);

            let growthRate = 1.0;
            if (i === 0) {
                const periodMu = mu / 100 * firstYearFraction;
                const periodSigma = sigma / 100 * Math.sqrt(firstYearFraction);
                growthRate = 1 + periodMu + randn_bm() * periodSigma;
            } else {
                for(let m=0; m<12; m++) {
                   growthRate *= (1 + monthlyMu + randn_bm() * monthlySigma);
                }
            }
            
            // è³‡ç”£æˆé•· (NISA)
            nisaBalance *= growthRate;
            
            // è³‡ç”£æˆé•· (ç‰¹å®š)
            taxableBalance *= growthRate;
            
            // ãƒªã‚¿ãƒ¼ãƒ³ç‡è¨ˆç®—ç”¨ (å…¨ä½“)
            const prevTotalInvest = (initialNisaBalance + initialTaxableBalance) || 1; // ç°¡æ˜“
            
            const currentTotalInvest = nisaBalance + taxableBalance;
            // ãƒªã‚¿ãƒ¼ãƒ³ç‡ã¯ã€ãã®å¹´ã®æˆé•·ç‡ã®ã¿ã‚’è¨˜éŒ² (ç°¡æ˜“)
            const returnRate = growthRate - 1;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼é©ç”¨
            cash += yearlyCashFlows[i].annualBalance - executedConditionalExpense;

            // å¼•é€€æ™‚ã®èª¿æ•´
            if (age === retirementAge) {
                // Target Cash adjustment
                if (cash < targetCashAtRetirement) {
                    const diff = targetCashAtRetirement - cash;
                    // Move from Invest to Cash (Taxable priority usually, but follow withdrawalPriority)
                    // Simplified: Try Taxable first, then NISA
                    let moveAmount = 0;
                    
                    // Helper to sell asset considering tax
                    const sellAsset = (amountNeeded) => {
                        let obtainedCash = 0;
                        let taxPaid = 0;
                        
                        // 1. Taxable
                        if (withdrawalPriority === 'taxable' && taxableBalance > 0) {
                            // å£²å´ç›Šè¨ˆç®—
                            const gainRatio = Math.max(0, (taxableBalance - taxablePrincipal) / taxableBalance);
                            // Gross needed: Net = Gross * (1 - gainRatio * taxRate)
                            // Gross = Net / (1 - gainRatio * taxRate)
                            const taxFactor = 1 - (gainRatio * (taxRate / 100));
                            let sellGross = amountNeeded / taxFactor;
                            
                            if (sellGross > taxableBalance) {
                                sellGross = taxableBalance;
                            }
                            
                            const principalRatio = taxablePrincipal / taxableBalance;
                            const principalDec = sellGross * principalRatio;
                            const gain = sellGross - principalDec;
                            const tax = gain * (taxRate / 100);
                            
                            taxableBalance -= sellGross;
                            taxablePrincipal -= principalDec;
                            obtainedCash += (sellGross - tax);
                            taxPaid += tax;
                            amountNeeded -= (sellGross - tax);
                        }
                        
                        // 2. NISA (No tax)
                        if (amountNeeded > 0 && nisaBalance > 0) {
                            let sellGross = amountNeeded;
                            if (sellGross > nisaBalance) sellGross = nisaBalance;
                            
                            nisaBalance -= sellGross;
                            obtainedCash += sellGross;
                            amountNeeded -= sellGross;
                        }
                        
                        // 3. Taxable (if priority was NISA)
                        if (amountNeeded > 0 && withdrawalPriority === 'nisa' && taxableBalance > 0) {
                             const gainRatio = Math.max(0, (taxableBalance - taxablePrincipal) / taxableBalance);
                             const taxFactor = 1 - (gainRatio * (taxRate / 100));
                             let sellGross = amountNeeded / taxFactor;
                             if (sellGross > taxableBalance) sellGross = taxableBalance;
                             
                             const principalRatio = taxablePrincipal / taxableBalance;
                             const principalDec = sellGross * principalRatio;
                             const gain = sellGross - principalDec;
                             const tax = gain * (taxRate / 100);
                             
                             taxableBalance -= sellGross;
                             taxablePrincipal -= principalDec;
                             obtainedCash += (sellGross - tax);
                             taxPaid += tax;
                        }
                        return { obtainedCash, taxPaid };
                    };
                    
                    const result = sellAsset(diff);
                    cash += result.obtainedCash;
                }
                
                if (withdrawalType === 'fixed_rate_retirement_start') {
                    fixedRetirementWithdrawalBase = (nisaBalance + taxableBalance) * (withdrawalValue / 100);
                    retirementYearInflationFactor = Math.pow(1 + inflationRate / 100, i);
                }
            }

            // --- æŠ•è³‡ (Accumulation) ---
            if (age < retirementAge || investAfterRetirement) {
                let invAmount = annualInvestment;
                if (i === 0) invAmount *= firstYearFraction;

                if (cash >= invAmount) {
                    cash -= invAmount;
                    
                    // NISAå„ªå…ˆ
                    if (investPriority === 'nisa') {
                        if (remainingNisaLimit > 0) {
                            const toNisa = Math.min(invAmount, remainingNisaLimit);
                            nisaBalance += toNisa;
                            remainingNisaLimit -= toNisa;
                            
                            const toTaxable = invAmount - toNisa;
                            if (toTaxable > 0) {
                                taxableBalance += toTaxable;
                                taxablePrincipal += toTaxable;
                            }
                        } else {
                            taxableBalance += invAmount;
                            taxablePrincipal += invAmount;
                        }
                    } else {
                        // ç‰¹å®šå£åº§å„ªå…ˆ
                        taxableBalance += invAmount;
                        taxablePrincipal += invAmount;
                    }
                }
            }

            // Reinvest excess cash (simplified: to Taxable)
            if (maxCashReserve > 0 && cash > maxCashReserve) {
                const excess = cash - maxCashReserve;
                cash -= excess;
                
                // Excess cash always to NISA if space available, then Taxable
                if (remainingNisaLimit > 0) {
                    const toNisa = Math.min(excess, remainingNisaLimit);
                    nisaBalance += toNisa;
                    remainingNisaLimit -= toNisa;
                    const toTaxable = excess - toNisa;
                    if (toTaxable > 0) {
                        taxableBalance += toTaxable;
                        taxablePrincipal += toTaxable;
                    }
                } else {
                    taxableBalance += excess;
                    taxablePrincipal += excess;
                }
            }

            // --- å–ã‚Šå´©ã— (Decumulation) ---
            let withdrawal = 0; // æ‰‹å–ã‚Šãƒ™ãƒ¼ã‚¹ã®å–ã‚Šå´©ã—é¡
            let totalTaxPaid = 0;

            if (age >= retirementAge) {
                let skip = false;
                if (returnRate < 0) {
                    if (withdrawalStrategy === 'skip_negative') skip = true;
                    else if (withdrawalStrategy === 'skip_negative_limited' && (age - retirementAge) < skipNegativeYearsLimit) skip = true;
                }

                if (!skip) {
                    let targetNet = 0;
                    const currentInflationFactor = Math.pow(1 + inflationRate / 100, i);
                    const totalInvest = nisaBalance + taxableBalance;

                    if (withdrawalType === 'fixed_amount') {
                        targetNet = withdrawalValue;
                    } else if (withdrawalType === 'fixed_rate') {
                        // å®šç‡ã¯ã€Œè³‡ç”£æ®‹é«˜ã®x%ã€ãªã®ã§ã€é€šå¸¸ã¯GrossæŒ‡å®šã€‚
                        // æ‰‹å–ã‚Šç¢ºä¿(Net)æŒ‡å®šã®å ´åˆã¯ã€ã€Œç¨å¼•å¾Œã«è³‡ç”£ã®x%ã«ãªã‚‹é¡ã€ã¨ã„ã†è§£é‡ˆã‚‚ã§ãã‚‹ãŒã€
                        // 4%ãƒ«ãƒ¼ãƒ«ç­‰ã¯ã€Œè³‡ç”£ã®4%ã‚’å–ã‚Šå´©ã™(Gross)ã€â†’ã€Œç¨å¼•å¾ŒãŒæ‰‹å–ã‚Šã€ãŒä¸€èˆ¬çš„ã€‚
                        // ã“ã“ã§ã¯ withdrawalAmountType ã«å¾“ã†ã€‚
                        const baseAmount = totalInvest * (withdrawalValue / 100);
                        if (withdrawalAmountType === 'gross') {
                            // GrossæŒ‡å®š: ã¾ãšé¡é¢ã‚’æ±ºå®šã—ã€ãã“ã‹ã‚‰ç¨é‡‘ã‚’å¼•ã„ã¦æ‰‹å–ã‚Šã¨ã™ã‚‹
                            // ã—ã‹ã—å¾Œç¶šã®å‡¦ç†ã¯ã€Œå¿…è¦ãªNetã€ã‚’æ¸¡ã—ã¦ã€ŒGrossã‚’é€†ç®—ã€ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€
                            // ã“ã“ã§ã€Œã“ã®Grossãªã‚‰Netã¯ã„ãã‚‰ã«ãªã‚‹ã‹ã€ã‚’æ¦‚ç®—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
                            // æ··åˆå£åº§ã ã¨è¤‡é›‘ã€‚
                            // ç°¡æ˜“çš„ã«: ç›®æ¨™é¡(Gross) ã‚’è¨­å®šã—ã€å£²å´ãƒ­ã‚¸ãƒƒã‚¯å†…ã§ Taxable/NISA ã‹ã‚‰ãã®é¡ã‚’æ¸›ã‚‰ã™ã€‚
                            // -> sellAsset é–¢æ•°ã‚’æ‹¡å¼µã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
                            targetNet = baseAmount; // ä¸€æ—¦baseAmountã‚’å…¥ã‚Œã‚‹ãŒã€å‡¦ç†åˆ†å²ãŒå¿…è¦
                        } else {
                            targetNet = baseAmount; // NetæŒ‡å®š: è³‡ç”£ã®x%ãŒæ‰‹å…ƒã«æ®‹ã‚‹ã‚ˆã†ã«å£²å´ (ã‚ˆã‚Šå¤šãæ¸›ã‚‹)
                        }
                        
                        if (maxCashReserve > 0 && (cash + targetNet) > maxCashReserve) {
                            targetNet = Math.max(0, maxCashReserve - cash);
                        }
                    } else if (withdrawalType === 'fixed_rate_retirement_start') {
                        targetNet = fixedRetirementWithdrawalBase * (currentInflationFactor / retirementYearInflationFactor);
                    } else if (withdrawalType === 'shortage' && (yearlyCashFlows[i].annualBalance - executedConditionalExpense) < 0) {
                        targetNet = -(yearlyCashFlows[i].annualBalance - executedConditionalExpense);
                    } else if (withdrawalType === 'keep_cash' && cash < targetCashAtRetirement) {
                        targetNet = targetCashAtRetirement - cash;
                    }

                    // --- å£²å´å®Ÿè¡Œé–¢æ•° (Net/Gross å¯¾å¿œç‰ˆ) ---
                    const executeSell = (targetValue, isNetTarget) => {
                        let obtainedNet = 0;
                        let taxPaid = 0;
                        let remainTarget = targetValue;

                        // æˆ¦ç•¥: Priorityã«å¾“ã£ã¦ãƒ«ãƒ¼ãƒ—
                        const sources = withdrawalPriority === 'nisa' ? ['nisa', 'taxable'] : ['taxable', 'nisa'];

                        for (const source of sources) {
                            if (remainTarget <= 0) break;

                            if (source === 'nisa' && nisaBalance > 0) {
                                // NISA: Gross = Net
                                let amount = remainTarget;
                                if (amount > nisaBalance) amount = nisaBalance;
                                
                                nisaBalance -= amount;
                                obtainedNet += amount;
                                remainTarget -= amount;
                            } else if (source === 'taxable' && taxableBalance > 0) {
                                // Taxable
                                const gainRatio = Math.max(0, (taxableBalance - taxablePrincipal) / taxableBalance);
                                
                                let sellGross = 0;
                                let sellNet = 0;
                                let sellTax = 0;

                                if (isNetTarget) {
                                    // æ‰‹å–ã‚Šç¢ºä¿: é€†ç®—
                                    const taxFactor = 1 - (gainRatio * (taxRate / 100));
                                    sellGross = remainTarget / taxFactor;
                                    if (sellGross > taxableBalance) sellGross = taxableBalance;
                                    
                                    // Recalculate Net from actual Gross
                                    const principalRatio = taxablePrincipal / taxableBalance;
                                    const principalDec = sellGross * principalRatio;
                                    const gain = sellGross - principalDec;
                                    sellTax = gain * (taxRate / 100);
                                    sellNet = sellGross - sellTax;
                                    
                                    taxableBalance -= sellGross;
                                    taxablePrincipal -= principalDec;
                                } else {
                                    // é¡é¢æŒ‡å®š: ãã®ã¾ã¾å£²å´
                                    sellGross = remainTarget;
                                    if (sellGross > taxableBalance) sellGross = taxableBalance;

                                    const principalRatio = taxablePrincipal / taxableBalance;
                                    const principalDec = sellGross * principalRatio;
                                    const gain = sellGross - principalDec;
                                    sellTax = gain * (taxRate / 100);
                                    sellNet = sellGross - sellTax;

                                    taxableBalance -= sellGross;
                                    taxablePrincipal -= principalDec;
                                }
                                
                                obtainedNet += sellNet;
                                taxPaid += sellTax;
                                remainTarget -= (isNetTarget ? sellNet : sellGross);
                            }
                        }
                        return { obtainedNet, taxPaid };
                    };

                    const isNet = withdrawalAmountType === 'net' || withdrawalType === 'shortage' || withdrawalType === 'keep_cash';
                    // shortageã‚„keep_cashã¯ã€Œæ‰‹å…ƒã®ç¾é‡‘ã€ã®è©±ãªã®ã§å¸¸ã«NetæŒ‡å®šæ‰±ã„ãŒå¦¥å½“
                    
                    const res = executeSell(targetNet, isNet);
                    withdrawal = res.obtainedNet;
                    totalTaxPaid = res.taxPaid;
                    cash += withdrawal;
                }
            }

            // Cashæ¯æ¸‡ãƒã‚§ãƒƒã‚¯ -> å¼·åˆ¶å£²å´ (å¸¸ã«NetæŒ‡å®š)
            if (cash < 0) {
                const shortage = -cash;
                // å¼·åˆ¶å£²å´ã¯å¸¸ã«ã€Œæ‰‹å–ã‚Šã§ä¸è¶³åˆ†ã‚’è£œã†ã€å¿…è¦ãŒã‚ã‚‹ãŸã‚NetæŒ‡å®š
                // Priorityã«å¾“ã£ã¦å£²å´
                const sources = withdrawalPriority === 'nisa' ? ['nisa', 'taxable'] : ['taxable', 'nisa'];
                let filled = 0;
                
                for (const source of sources) {
                    if (filled >= shortage) break;
                    const needed = shortage - filled;

                    if (source === 'nisa' && nisaBalance > 0) {
                        let amount = needed;
                        if (amount > nisaBalance) amount = nisaBalance;
                        nisaBalance -= amount;
                        filled += amount;
                        withdrawal += amount;
                    } else if (source === 'taxable' && taxableBalance > 0) {
                        const gainRatio = Math.max(0, (taxableBalance - taxablePrincipal) / taxableBalance);
                        const taxFactor = 1 - (gainRatio * (taxRate / 100));
                        let sellGross = needed / taxFactor;
                        if (sellGross > taxableBalance) sellGross = taxableBalance;

                        const principalRatio = taxablePrincipal / taxableBalance;
                        const principalDec = sellGross * principalRatio;
                        const gain = sellGross - principalDec;
                        const tax = gain * (taxRate / 100);
                        const net = sellGross - tax;

                        taxableBalance -= sellGross;
                        taxablePrincipal -= principalDec;
                        filled += net;
                        withdrawal += net;
                        totalTaxPaid += tax;
                    }
                }
                cash += filled;
            }
            
            const totalAsset = cash + nisaBalance + taxableBalance;
            if (totalAsset < 0) neverDepleted = false;

            simDataAtYear[i].push({ 
                total: totalAsset, 
                cash, 
                nisaBalance, 
                taxableBalance, 
                returnRate, 
                withdrawal, 
                executedConditionalExpense,
                taxPaid: totalTaxPaid 
            });
        }
        if (neverDepleted) successCount++;
    }

    const finalYearData = simDataAtYear[duration - 1].map((d, idx) => ({ ...d, index: idx })).sort((a, b) => a.total - b.total);
    const idx10 = finalYearData[Math.floor(simCount * 0.1)]?.index || 0;
    const idx50 = finalYearData[Math.floor(simCount * 0.5)]?.index || 0;
    const idx90 = finalYearData[Math.floor(simCount * 0.9)]?.index || 0;

    const extractReturns = (simIdx) => simDataAtYear.map(yd => yd[simIdx].returnRate);
    const extractFinal = (simIdx) => simDataAtYear[duration - 1][simIdx].total;
    
    const findDepletionAge = (simIdx) => {
        for (let i = 0; i < duration; i++) {
            if (simDataAtYear[i][simIdx].total < 0) {
                return currentAge + i;
            }
        }
        return null;
    };

    // --- Max Withdrawal Rate (Simplified for Tax) ---
    // ç¨é‡‘è¨ˆç®—ãŒå…¥ã‚‹ã¨Max Withdrawal Rateã®é€†ç®—ã¯éå¸¸ã«é‡ããªã‚‹ãŸã‚ã€ç°¡æ˜“çš„ã«æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯(ç¨å¼•å‰ãƒ™ãƒ¼ã‚¹)ã‚’ç¶­æŒã€
    // ã‚‚ã—ãã¯ä»Šå›ã¯ã€Œæ‰‹å–ã‚Šãƒ™ãƒ¼ã‚¹ã€ã§ã®æ¯æ¸‡ç‡ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã®æŒ‡æ¨™ã®é‡è¦åº¦ã¯ä¸‹ãŒã‚‹ã€‚
    // ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ä¸€æ—¦0ã‚’è¿”ã™ã‹ã€ç°¡æ˜“è¨ˆç®—ã«ã¨ã©ã‚ã‚‹ã€‚
    const calculateMaxWithdrawalRate = () => 0; // High computational cost with tax

    setSummaryMetrics({
        pessimistic: { ...calculateMetrics(extractReturns(idx10), extractFinal(idx10)), maxWithdrawalRate: 0, depletionAge: findDepletionAge(idx10) },
        central: { ...calculateMetrics(extractReturns(idx50), extractFinal(idx50)), maxWithdrawalRate: 0, depletionAge: findDepletionAge(idx50) },
        optimistic: { ...calculateMetrics(extractReturns(idx90), extractFinal(idx90)), maxWithdrawalRate: 0, depletionAge: findDepletionAge(idx90) }
    });

    const res = yearlyCashFlows.map((cf, i) => {
        const final_p10 = simDataAtYear[i][idx10];
        const final_p50 = simDataAtYear[i][idx50];
        const final_p90 = simDataAtYear[i][idx90];

        const sortedThisYear = [...simDataAtYear[i]].sort((a, b) => a.total - b.total);
        const yearly_p10 = sortedThisYear[Math.floor(simCount * 0.1)] || sortedThisYear[0];
        const yearly_p50 = sortedThisYear[Math.floor(simCount * 0.5)] || sortedThisYear[0];
        const yearly_p90 = sortedThisYear[Math.floor(simCount * 0.9)] || sortedThisYear[0];

        const displayExpense = cf.expense + (final_p50.executedConditionalExpense || 0);
        const displayBalance = cf.income - displayExpense;
        const displayEventExpense = cf.eventExpense + (final_p50.executedConditionalExpense || 0);

        // Helper to format simulation data rows
        const createRowData = (prefix, data) => ({
            [`${prefix}_total`]: Math.round(data.total),
            [`${prefix}_cash`]: Math.round(data.cash),
            [`${prefix}_invest`]: Math.round(data.nisaBalance + data.taxableBalance),
            [`${prefix}_nisa`]: Math.round(data.nisaBalance),
            [`${prefix}_taxable`]: Math.round(data.taxableBalance),
            [`${prefix}_return`]: (data.returnRate * 100).toFixed(1),
            [`${prefix}_withdrawal`]: Math.round(data.withdrawal),
            [`${prefix}_tax`]: Math.round(data.taxPaid),
        });

        return {
            age: cf.age,
            income: Math.round(cf.income),
            expense: Math.round(displayExpense),
            annualBalance: Math.round(displayBalance),
            baseLivingCost: Math.round(cf.baseLivingCost),
            housingCost: Math.round(cf.housingCost),
            educationCost: Math.round(cf.educationCost),
            eventExpense: Math.round(displayEventExpense),

            // Final Year Based
            ...createRowData('final_pessimistic', final_p10),
            ...createRowData('final_central', final_p50),
            ...createRowData('final_optimistic', final_p90),

            // Yearly Based
            ...createRowData('yearly_pessimistic', yearly_p10),
            ...createRowData('yearly_central', yearly_p50),
            ...createRowData('yearly_optimistic', yearly_p90),

            // Legacy keys for chart compatibility
            pessimistic_total: Math.round(final_p10.total),
            central_total: Math.round(final_p50.total),
            optimistic_total: Math.round(final_p90.total),

            event: cf.eventNames
        };
    });

    setSimulationData(res);
    
    const calculateSurvivalRateAtAge = (targetAge) => {
        const idx = targetAge - currentAge;
        if (idx < 0 || idx >= duration) return null;
        const count = simDataAtYear[idx].filter(d => d.total >= 0).length;
        return (count / simCount) * 100;
    };

    const survivalRates = {
        age85: calculateSurvivalRateAtAge(85),
        age90: calculateSurvivalRateAtAge(90),
        age95: calculateSurvivalRateAtAge(95),
    };

    const assetAtRetirementIdx = retirementAge - currentAge;
    setStats({
        minP10: Math.min(...res.map(d => d.final_pessimistic_total)),
        finalP50: res[res.length-1].final_central_total,
        negativeAge: res.find(d => d.final_pessimistic_total < 0)?.age,
        successRate: (successCount / simCount) * 100,
        assetAtRetirement: assetAtRetirementIdx >= 0 ? res[assetAtRetirementIdx].final_central_total : 0,
        survivalRates 
    });

  }, [currentAge, retirementAge, pensionStartAge, lifeExpectancy, yearlyIncome, spouseIncome, initialCash, initialNisaBalance, initialTaxableBalance, initialTaxablePrincipal, nisaLifetimeLimit, investPriority, withdrawalPriority, withdrawalAmountType, taxRate, incomeGrowth, inflationRate, macroSlide, expectedReturn, risk, monthlyExpense, housingExpense, housingType, mortgageBalance, mortgageYears, mortgageRate, currentPortfolio, targetPortfolio, glidePathYears, annualInvestment, investAfterRetirement, withdrawalType, withdrawalValue, targetCashAtRetirement, withdrawalStrategy, skipNegativeYearsLimit, simulationCount, getEducationExpense, postRetirementExpenseRatio, ushapePhase1Ratio, ushapePhase2Ratio, maxCashReserve]);

  useEffect(() => {
    setIsCalculating(true);
    const t = setTimeout(() => { runMonteCarloSimulation(); setIsCalculating(false); }, 600);
    return () => clearTimeout(t);
  }, [runMonteCarloSimulation]);

  const yAxisTickFormatter = (val) => (Math.abs(val) >= 10000 ? (val / 10000).toFixed(0) + 'å„„' : val + 'ä¸‡');
  const getKey = (base) => chartMode === 'final_year' ? `final_${base}` : `yearly_${base}`;
  
  // Create scenario prefix helper
  const breakdownPrefix = breakdownScenario === 'p10' ? 'pessimistic' : breakdownScenario === 'p90' ? 'optimistic' : 'central';

  // --- Render ---
  return (
    <div className={`min-h-screen bg-slate-50 p-2 md:p-6 font-sans text-slate-800`}>
      {showAssetInfo && <AssetInfoModal onClose={() => setShowAssetInfo(false)} />}
      {showEducationInfo && <EducationCostModal onClose={() => setShowEducationInfo(false)} />}
      
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold flex items-center gap-2"><TrendingUp/> ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ Expert <span className="text-xs font-normal text-slate-500 bg-slate-200 px-2 py-0.5 rounded">v3.0 ç¨é‡‘ãƒ»NISAå¯¾å¿œ</span></h1>
            <div className="flex gap-3 items-center">
                <button onClick={resetSettings} className="text-xs underline hover:text-red-500">ãƒªã‚»ãƒƒãƒˆ</button>
                <span className="text-xs bg-white px-2 py-1 rounded border flex gap-1"><Save size={12}/> ä¿å­˜ON</span>
            </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          {/* Left Panel */}
          <div className="lg:col-span-4 space-y-4 h-fit lg:max-h-[calc(100vh-100px)] lg:overflow-y-auto custom-scrollbar">
            {/* ... (æœ¬äººãƒ»é…å¶è€…ãƒ»å­ä¾›ãƒ‘ãƒãƒ«ã¯å¤‰æ›´ãªã—) ... */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 className="font-bold text-sm mb-2 text-slate-700 flex items-center gap-2"><User size={16}/> æœ¬äºº</h3>
                <div className="grid grid-cols-2 gap-2">
                    <div className="col-span-2 flex items-center justify-between mb-2">
                        <label className="text-[10px] text-slate-500 flex items-center gap-1">ç”Ÿå¹´æœˆæ—¥</label>
                        <div className="flex items-center gap-2">
                             <input type="date" value={userBirthDate} onChange={(e) => setUserBirthDate(e.target.value)} className="p-1 text-xs border rounded text-right bg-white" />
                             <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">{currentAge}æ­³</span>
                        </div>
                    </div>
                    <InputGroup label="å¼•é€€å¹´é½¢" value={retirementAge} onChange={setRetirementAge} unit="æ­³"/>
                    <InputGroup label="é€€è·é‡‘" value={retirementIncome} onChange={setRetirementIncome} unit="ä¸‡å††"/>
                    <InputGroup label="æ‰‹å–ã‚Šå¹´å" value={yearlyIncome} onChange={setYearlyIncome} unit="ä¸‡å††"/>
                    <InputGroup label="å¹´é‡‘é–‹å§‹" value={pensionStartAge} onChange={setPensionStartAge} unit="æ­³"/>
                    <InputGroup label="å¹´é‡‘(å¹´é¡)" value={pension} onChange={setPension} unit="ä¸‡å††"/>
                    <InputGroup label="ã‚·ãƒŸãƒ¥çµ‚äº†" value={lifeExpectancy} onChange={setLifeExpectancy} unit="æ­³"/>
                </div>
            </div>
            
            <div className={`bg-white p-4 rounded-xl shadow-sm border transition-colors duration-300 ${hasSpouse ? 'border-indigo-200 bg-indigo-50/30' : 'border-slate-200'}`}>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="font-bold text-sm flex items-center gap-2 text-slate-700 uppercase tracking-wider"><Users size={16}/> é…å¶è€…</h2>
                  <label className="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" checked={hasSpouse} onChange={e => setHasSpouse(e.target.checked)} className="sr-only peer" />
                    <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                  </label>
                </div>
                {hasSpouse && (
                  <div className="grid grid-cols-2 gap-x-4 gap-y-3">
                    <div className="col-span-2 flex items-center justify-between">
                        <label className="text-[10px] text-slate-500 flex items-center gap-1">ç”Ÿå¹´æœˆæ—¥</label>
                        <div className="flex items-center gap-2">
                             <input type="date" value={spouseBirthDate} onChange={(e) => setSpouseBirthDate(e.target.value)} className="p-1 text-xs border rounded text-right bg-white" />
                             <span className="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-100">{spouseAge}æ­³</span>
                        </div>
                    </div>
                    <InputGroup label="æ‰‹å–ã‚Šå¹´å" value={spouseIncome} onChange={setSpouseIncome} unit="ä¸‡å††" />
                    <InputGroup label="å¼•é€€å¹´é½¢" value={spouseRetirementAge} onChange={setSpouseRetirementAge} unit="æ­³" />
                    <InputGroup label="é€€è·é‡‘(æ‰‹å–)" value={spouseRetirementIncome} onChange={setSpouseRetirementIncome} unit="ä¸‡å††" />
                    <InputGroup label="å¹´é‡‘é–‹å§‹" value={spousePensionStartAge} onChange={setSpousePensionStartAge} unit="æ­³" />
                    <InputGroup label="å¹´é‡‘(å¹´é¡)" value={spousePension} onChange={setSpousePension} unit="ä¸‡å††" />
                  </div>
                )}
            </div>

            {/* --- è³‡ç”£ãƒ»ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª (Updated) --- */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 className="font-bold text-sm mb-2 flex items-center gap-2"><Coins size={16}/> è³‡ç”£æ®‹é«˜ãƒ»ç¨®åˆ¥</h3>
                <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2">
                        <div className="col-span-2"><InputGroup label="è²¯è“„(ç¾é‡‘)" value={initialCash} onChange={setInitialCash} unit="ä¸‡å††" icon={<PiggyBank size={12}/>}/></div>
                        <InputGroup label="NISAæ®‹é«˜" value={initialNisaBalance} onChange={setInitialNisaBalance} unit="ä¸‡å††" icon={<Wallet size={12} className="text-green-500"/>}/>
                        <InputGroup label="æ®‹ã‚Šéèª²ç¨æ " value={nisaLifetimeLimit} onChange={setNisaLifetimeLimit} unit="ä¸‡å††" helpText="ä¸–å¸¯åˆè¨ˆ"/>
                        <InputGroup label="ç‰¹å®šå£åº§æ®‹é«˜" value={initialTaxableBalance} onChange={setInitialTaxableBalance} unit="ä¸‡å††" icon={<Wallet size={12} className="text-slate-500"/>}/>
                        <InputGroup label="ç‰¹å®šå£åº§å…ƒæœ¬" value={initialTaxablePrincipal} onChange={setInitialTaxablePrincipal} unit="ä¸‡å††" helpText="ç¨è¨ˆç®—ç”¨"/>
                    </div>
                    
                    <div className="bg-orange-50 p-2 rounded border border-orange-100 grid grid-cols-2 gap-2">
                        <div className="col-span-2 text-[10px] font-bold text-orange-800 flex items-center gap-1"><SlidersHorizontal size={12}/> å„ªå…ˆé †ä½ãƒ»ç¨é‡‘è¨­å®š</div>
                        <div className="col-span-2 flex items-center justify-between">
                            <label className="text-[10px] text-slate-600">ç©ç«‹å„ªå…ˆ</label>
                            <div className="flex bg-white rounded border overflow-hidden">
                                <button onClick={()=>setInvestPriority('nisa')} className={`px-2 py-0.5 text-[10px] ${investPriority==='nisa'?'bg-green-100 text-green-800 font-bold':'text-slate-400'}`}>NISA</button>
                                <button onClick={()=>setInvestPriority('taxable')} className={`px-2 py-0.5 text-[10px] ${investPriority==='taxable'?'bg-slate-100 text-slate-800 font-bold':'text-slate-400'}`}>ç‰¹å®š</button>
                            </div>
                        </div>
                        <div className="col-span-2 flex items-center justify-between">
                            <label className="text-[10px] text-slate-600">å–å´©å„ªå…ˆ</label>
                            <div className="flex bg-white rounded border overflow-hidden">
                                <button onClick={()=>setWithdrawalPriority('taxable')} className={`px-2 py-0.5 text-[10px] ${withdrawalPriority==='taxable'?'bg-slate-100 text-slate-800 font-bold':'text-slate-400'}`}>ç‰¹å®š</button>
                                <button onClick={()=>setWithdrawalPriority('nisa')} className={`px-2 py-0.5 text-[10px] ${withdrawalPriority==='nisa'?'bg-green-100 text-green-800 font-bold':'text-slate-400'}`}>NISA</button>
                            </div>
                        </div>
                        <div className="col-span-2 flex items-center justify-between">
                            <label className="text-[10px] text-slate-600" title="å–ã‚Šå´©ã—é¡ã®æŒ‡å®šæ–¹æ³•">å–å´©é¡æŒ‡å®š</label>
                            <div className="flex bg-white rounded border overflow-hidden">
                                <button onClick={()=>setWithdrawalAmountType('net')} className={`px-2 py-0.5 text-[10px] ${withdrawalAmountType==='net'?'bg-blue-100 text-blue-800 font-bold':'text-slate-400'}`} title="æ‰‹å–ã‚Šé¡ã‚’ç¢ºä¿ã™ã‚‹ã‚ˆã†ã«ã€ç¨é‡‘åˆ†ã‚’ä¸Šä¹—ã›ã—ã¦å£²å´ã—ã¾ã™">ç¨å¼•å¾Œ(æ‰‹å–)</button>
                                <button onClick={()=>setWithdrawalAmountType('gross')} className={`px-2 py-0.5 text-[10px] ${withdrawalAmountType==='gross'?'bg-slate-100 text-slate-800 font-bold':'text-slate-400'}`} title="æŒ‡å®šé¡ã‚’å£²å´ã—ã€ãã“ã‹ã‚‰ç¨é‡‘ãŒå¼•ã‹ã‚Œã¾ã™">ç¨å¼•å‰(é¡é¢)</button>
                            </div>
                        </div>
                        <InputGroup label="é‹ç”¨ç›Šç¨ç‡" value={taxRate} onChange={setTaxRate} unit="%" step={0.001} />
                    </div>

                    {/* ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè¨­å®š */}
                    <div className="bg-indigo-50 p-2 rounded border border-indigo-100">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-[10px] font-bold text-indigo-700 flex items-center gap-1"><Settings2 size={12}/> ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè¨­å®š (å…¨å£åº§å…±é€š)</label>
                            <button onClick={() => setShowPortfolioModal(!showPortfolioModal)} className="text-[10px] bg-white border px-2 py-0.5 rounded hover:bg-indigo-100">{showPortfolioModal ? 'é–‰ã˜ã‚‹' : 'ç·¨é›†'}</button>
                        </div>
                        {showPortfolioModal ? (
                            <div className="space-y-3 animate-in fade-in">
                                {/* ... (ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç·¨é›†UIã¯å¤‰æ›´ãªã—) ... */}
                                <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-[10px] font-bold text-center mb-1">ç¾åœ¨ (Start)</p>
                                    {Object.keys(ASSET_CLASSES).map(key => (
                                        <div key={key} className="flex items-center gap-1 mb-1">
                                            <div className="w-1.5 h-1.5 rounded-full flex-shrink-0" style={{backgroundColor:ASSET_CLASSES[key].color}}></div>
                                            <span className="text-[10px] flex-1 truncate">{ASSET_CLASSES[key].name}</span>
                                            <input 
                                                type="number" 
                                                min="0" max="100" 
                                                value={currentPortfolio[key]} 
                                                onChange={(e) => updatePortfolio('current', key, e.target.value)}
                                                className="w-8 p-0.5 text-[10px] border rounded text-right flex-shrink-0"
                                            />
                                            <span className="text-[9px]">%</span>
                                        </div>
                                    ))}
                                    <div className="text-[10px] font-bold mt-1 text-center">{Object.values(currentPortfolio).reduce((a,b)=>a+b,0)}%</div>
                                </div>
                                <div>
                                    <p className="text-[10px] font-bold text-center mb-1">ç›®æ¨™ (End)</p>
                                    {Object.keys(ASSET_CLASSES).map(key => (
                                        <div key={key} className="flex items-center gap-1 mb-1">
                                            <span className="text-[10px] flex-1 truncate">{ASSET_CLASSES[key].name}</span>
                                            <input 
                                                type="number" 
                                                value={targetPortfolio[key]} 
                                                onChange={(e) => updatePortfolio('target', key, e.target.value)} 
                                                className="w-8 p-0.5 text-[10px] border rounded text-right flex-shrink-0"
                                            />
                                            <span className="text-[9px]">%</span>
                                        </div>
                                    ))}
                                    <div className="text-[10px] font-bold mt-1 text-center">{Object.values(targetPortfolio).reduce((a,b)=>a+b,0)}%</div>
                                </div>
                            </div>
                                <div><InputGroup label="ç§»è¡ŒæœŸé–“ (ã‚°ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚¹)" value={glidePathYears} onChange={setGlidePathYears} unit="å¹´"/></div>
                                <button onClick={() => setShowAssetInfo(true)} className="w-full mt-2 text-[10px] bg-slate-200 hover:bg-slate-300 py-1 rounded flex items-center justify-center gap-1"><BarChart2 size={10}/> ğŸ“Š ã‚¢ã‚»ãƒƒãƒˆè©³ç´°ãƒ»ç›¸é–¢è¡¨ã‚’ç¢ºèª</button>
                            </div>
                        ) : (
                            <div className="flex gap-2 text-[10px]">
                                <div className="flex-1"><span className="block font-bold">ç¾åœ¨</span><span>æœŸå¾…åˆ©å›ã‚Š: {currentStats.return.toFixed(1)}%</span><br/><span>ãƒªã‚¹ã‚¯: {currentStats.risk.toFixed(1)}%</span></div>
                                <ArrowRight size={14} className="text-slate-400 mt-2"/>
                                <div className="flex-1"><span className="block font-bold">ç›®æ¨™</span><span>æœŸå¾…åˆ©å›ã‚Š: {targetStats.return.toFixed(1)}%</span><br/><span>ãƒªã‚¹ã‚¯: {targetStats.risk.toFixed(1)}%</span></div>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* ... (å­ä¾›ãƒ»ä½å±…ãƒ‘ãƒãƒ«ã¯å¤‰æ›´ãªã—) ... */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
              <div className="flex justify-between items-center mb-3">
                 <h2 className="font-bold text-sm flex items-center gap-2 text-slate-700 uppercase tracking-wider"><Baby size={16}/> å­ä¾›ãƒ»æ•™è‚²è²»</h2>
                 <button onClick={() => setShowEducationInfo(true)} className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100 flex items-center gap-1 hover:bg-indigo-100">
                    <Info size={10}/> è²»ç”¨ã®å†…è¨³ãƒ»è©³ç´°ã‚’ç¢ºèª
                 </button>
              </div>
              <div className="space-y-4 mb-4">
                {children.map((child, index) => (
                  <div key={child.id} className="bg-slate-50 p-3 rounded border border-slate-100 text-sm space-y-3 relative group">
                    <div className="flex justify-between items-center border-b pb-2">
                        <div className="flex items-center gap-2">
                           <span className="font-bold text-indigo-700 flex items-center gap-1"><User size={14}/> ç¬¬{index + 1}å­</span>
                           <input type="date" value={child.birthDate} onChange={(e) => updateChildBirthDate(index, e.target.value)} className="w-24 p-1 text-xs border rounded bg-white outline-none" />
                           <span className="text-xs text-slate-500 font-bold bg-white px-1 rounded border border-slate-200">{calculateAge(child.birthDate)}æ­³</span>
                        </div>
                      <button onClick={() => removeChild(child.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={14} /></button>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                        <div className="col-span-1"><label className="block text-[10px] text-slate-500">å°å­¦æ ¡</label><select value={child.edu.elementary} onChange={(e) => updateChildEdu(index, 'elementary', e.target.value)} className="w-full p-1 text-xs border rounded bg-white"><option value="public">å…¬ç«‹</option><option value="private">ç§ç«‹</option></select></div>
                         <div className="col-span-1"><label className="block text-[10px] text-slate-500">ä¸­å­¦æ ¡</label><select value={child.edu.middle} onChange={(e) => updateChildEdu(index, 'middle', e.target.value)} className="w-full p-1 text-xs border rounded bg-white"><option value="public">å…¬ç«‹</option><option value="private">ç§ç«‹</option></select></div>
                         <div className="col-span-1"><label className="block text-[10px] text-slate-500">é«˜æ ¡</label><select value={child.edu.high} onChange={(e) => updateChildEdu(index, 'high', e.target.value)} className="w-full p-1 text-xs border rounded bg-white"><option value="public">å…¬ç«‹</option><option value="private">ç§ç«‹</option></select></div>
                        <div className="col-span-1"><label className="block text-[10px] text-slate-500">å¤§å­¦</label><select value={child.edu.university} onChange={(e) => updateChildEdu(index, 'university', e.target.value)} className="w-full p-1 text-xs border rounded bg-white"><option value="national">å›½å…¬ç«‹</option><option value="private_hum">ç§ç«‹(æ–‡)</option><option value="private_sci">ç§ç«‹(ç†)</option><option value="none">è¡Œã‹ãªã„</option></select></div>
                    </div>
                    <div className="bg-white p-2 rounded border border-slate-100 mt-2">
                        <div className="text-[10px] text-slate-500 mb-1 flex items-center gap-1"><GraduationCap size={12}/> å¡¾ãƒ»ç¿’ã„äº‹</div>
                        <div className="flex items-center gap-2">
                             <div className="flex-1"><label className="text-[10px] text-slate-400">é–‹å§‹</label><input type="number" min="0" max="22" value={child.cram.start} onChange={(e) => updateChildCram(index, 'start', e.target.value)} className="w-full p-1 text-xs border rounded" /></div>
                             <span className="text-slate-400">~</span>
                             <div className="flex-1"><label className="text-[10px] text-slate-400">çµ‚äº†</label><input type="number" min="0" max="22" value={child.cram.end} onChange={(e) => updateChildCram(index, 'end', e.target.value)} className="w-full p-1 text-xs border rounded" /></div>
                             <span className="text-xs text-slate-500 pt-3">æ­³</span>
                        </div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="flex gap-2 items-center p-2 bg-indigo-50 rounded border border-indigo-100"><button onClick={addChild} className="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 text-xs flex items-center justify-center gap-1 font-bold"><Plus size={14}/> å­ä¾›ã‚’è¿½åŠ </button></div>
            </div>

             <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
              <h2 className="font-bold text-sm mb-3 flex items-center gap-2 text-slate-700 uppercase tracking-wider"><Home size={16}/> ä½å±…ãƒ»ãƒ­ãƒ¼ãƒ³</h2>
              <div>
                    <div className="flex items-center gap-4 mb-3">
                        <label className="text-xs font-bold text-slate-600 flex items-center gap-1"><Home size={12}/> ä½å±…ã‚¿ã‚¤ãƒ—</label>
                        <div className="flex bg-slate-100 p-1 rounded">
                            <button onClick={() => setHousingType('rent')} className={`px-3 py-1 text-xs rounded transition-colors ${housingType === 'rent' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>è³ƒè²¸</button>
                            <button onClick={() => setHousingType('owned')} className={`px-3 py-1 text-xs rounded transition-colors ${housingType === 'owned' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>æŒã¡å®¶</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <InputGroup label={housingType === 'rent' ? "å®¶è³ƒ(æœˆ)" : "ç®¡ç†ä¿®ç¹•è²»(æœˆ)"} value={housingExpense} onChange={setHousingExpense} unit="ä¸‡å††" />
                        {housingType === 'owned' && (
                            <>
                                <InputGroup label="ãƒ­ãƒ¼ãƒ³æ®‹å‚µ" value={mortgageBalance} onChange={setMortgageBalance} unit="ä¸‡å††" />
                                <InputGroup label="æ®‹ã‚Šå¹´æ•°" value={mortgageYears} onChange={setMortgageYears} unit="å¹´" />
                                <InputGroup label="é‡‘åˆ©" value={mortgageRate} onChange={setMortgageRate} unit="%" step={0.01}/>
                            </>
                        )}
                    </div>
                 </div>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                 <h3 className="font-bold text-sm mb-2">ğŸ’³ åæ”¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
                 {/* ... (åæ”¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ãƒãƒ«ã¯ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—ã€è¡¨ç¤ºã®ã¿) ... */}
                 <div className="space-y-3">
                     <div className="grid grid-cols-2 gap-4">
                        <InputGroup label="æœˆç”Ÿæ´»è²»" value={monthlyExpense} onChange={setMonthlyExpense} unit="ä¸‡å††"/>
                        <InputGroup label="æ˜‡çµ¦ç‡(å¹´)" value={incomeGrowth} onChange={setIncomeGrowth} unit="%" step={0.1} />
                        <InputGroup label="ã‚¤ãƒ³ãƒ•ãƒ¬ç‡(å¹´)" value={inflationRate} onChange={setInflationRate} unit="%" step={0.1} />
                        <InputGroup label="å¹´é‡‘èª¿æ•´(ã‚¹ãƒ©ã‚¤ãƒ‰)" value={macroSlide} onChange={setMacroSlide} unit="%" step={0.1} />
                     </div>

                     <div className="bg-indigo-50/50 p-2 rounded border border-indigo-100 space-y-3">
                        <div className="flex flex-col gap-2">
                            <label className="text-[10px] font-bold text-indigo-700 flex items-center gap-1"><ArrowUpCircle size={12}/> ç©ç«‹æŠ•è³‡</label>
                            <div className="flex items-center gap-2">
                                <InputGroup label="å¹´é–“å…¥é‡‘é¡" value={annualInvestment} onChange={setAnnualInvestment} unit="ä¸‡å††" />
                                <label className="flex items-center gap-1 text-[10px] mt-4 whitespace-nowrap cursor-pointer">
                                    <input type="checkbox" checked={investAfterRetirement} onChange={e => setInvestAfterRetirement(e.target.checked)} className="accent-indigo-600"/> å¼•é€€å¾Œã‚‚ç¶™ç¶š
                                </label>
                            </div>
                        </div>
                        <div className="border-t border-indigo-100"></div>
                        <div className="flex flex-col gap-2">
                            <label className="text-[10px] font-bold text-orange-700 flex items-center gap-1"><ArrowDownCircle size={12}/> å–ã‚Šå´©ã—ãƒ»ç¾é‡‘ç®¡ç†</label>
                            <div className="grid grid-cols-2 gap-2">
                                <div className="col-span-2 flex items-center gap-2">
                                    <InputGroup label="å¼•é€€æ™‚ç›®æ¨™ç¾é‡‘" value={targetCashAtRetirement} onChange={setTargetCashAtRetirement} unit="ä¸‡å††" />
                                </div>
                                <div className="col-span-2">
                                    <label className="block text-[10px] text-slate-500 mb-1">å–ã‚Šå´©ã—æ–¹å¼</label>
                                    <select value={withdrawalType} onChange={e=>setWithdrawalType(e.target.value)} className="w-full p-1.5 text-xs border rounded bg-white">
                                        <option value="none">ãªã—</option>
                                        <option value="fixed_amount">å®šé¡ (ä¸‡å††)</option>
                                        <option value="fixed_rate">å®šç‡ (æ¯å¹´å†è¨ˆç®—)</option>
                                        <option value="fixed_rate_retirement_start">å®šç‡ (å¼•é€€æ™‚æ±ºå®šãƒ»å›ºå®š)</option>
                                        <option value="shortage">ä¸è¶³é¡ (åæ”¯è£œå¡«)</option>
                                        <option value="keep_cash">ç¾é‡‘ä¸€å®š (ç›®æ¨™ç¶­æŒ)</option>
                                    </select>
                                </div>
                                {(withdrawalType === 'fixed_rate' || withdrawalType === 'fixed_amount' || withdrawalType === 'fixed_rate_retirement_start') && (
                                    <div className="col-span-2 flex items-center gap-2 mt-1">
                                        <input type="number" value={withdrawalValue} onChange={e=>setWithdrawalValue(Number(e.target.value))} className="w-20 p-1.5 text-xs border rounded"/>
                                        <span className="text-xs text-slate-500">{withdrawalType === 'fixed_amount' ? 'ä¸‡å††/å¹´' : '%/å¹´'}</span>
                                    </div>
                                )}
                                {withdrawalType === 'fixed_rate' && (
                                    <div className="col-span-2 flex items-center gap-2 mt-1 bg-white p-1 rounded border border-orange-200">
                                        <label className="text-[10px] text-orange-700 whitespace-nowrap">ç¾é‡‘ä¸Šé™</label>
                                        <input type="number" value={maxCashReserve} onChange={e=>setMaxCashReserve(Number(e.target.value))} className="w-16 p-1 text-xs border rounded text-right"/>
                                        <span className="text-[10px] text-slate-400">ä¸‡</span>
                                    </div>
                                )}
                                <div className="col-span-2 mt-2">
                                    <label className="block text-[10px] text-slate-500 mb-1 flex items-center gap-1"><ShieldAlert size={10}/> ãƒã‚¤ãƒŠã‚¹ãƒªã‚¿ãƒ¼ãƒ³æ™‚ã®å¯¾å¿œ</label>
                                    <select value={withdrawalStrategy} onChange={e=>setWithdrawalStrategy(e.target.value)} className="w-full p-1.5 text-xs border rounded bg-white">
                                        <option value="always">å¸¸ã«å®Ÿè¡Œ</option>
                                        <option value="skip_negative">ãƒã‚¤ãƒŠã‚¹æ™‚ã¯åœæ­¢(æ°¸ç¶š)</option>
                                        <option value="skip_negative_limited">ãƒã‚¤ãƒŠã‚¹æ™‚ã¯åœæ­¢(æœŸé–“åˆ¶é™)</option>
                                    </select>
                                </div>
                                {withdrawalStrategy === 'skip_negative_limited' && (
                                    <div className="col-span-2 flex items-center gap-2 mt-1">
                                        <span className="text-[10px] text-slate-500">å¼•é€€å¾Œ</span>
                                        <input type="number" value={skipNegativeYearsLimit} onChange={e => setSkipNegativeYearsLimit(Number(e.target.value))} className="w-12 p-1.5 text-xs border rounded"/>
                                        <span className="text-[10px] text-slate-500">å¹´é–“ã¯åœæ­¢</span>
                                    </div>
                                )}
                            </div>
                            <p className="text-[9px] text-slate-400 mt-1">â€»ç¾é‡‘ãŒæ¯æ¸‡ã™ã‚‹å ´åˆã¯è¨­å®šã«é–¢ã‚ã‚‰ãšè£œå¡«ã—ã¾ã™</p>
                        </div>
                    </div>
                     
                     <div className="border-t pt-2">
                      <div className="space-y-2">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-[10px] font-semibold text-slate-500 mb-1 flex items-center gap-1"><TrendingDown size={12}/> è€å¾Œã®æ”¯å‡ºå¤‰åŒ–</label>
                                <select value={spendingPattern} onChange={(e) => setSpendingPattern(e.target.value)} className="w-full p-1.5 bg-slate-50 border border-slate-200 rounded text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="flat">ä¸€å®š (ã‚¤ãƒ³ãƒ•ãƒ¬ã®ã¿)</option><option value="linear">å¾ã€…ã«æ¸›å°‘ (å®šç‡)</option><option value="ushape">æ®µéšçš„å¤‰åŒ– (Uå­—å‹)</option>
                                </select>
                            </div>
                        </div>
                        <div className="bg-slate-50 p-2 rounded border border-slate-100 space-y-2">
                             <InputGroup label="é€€è·å¾Œã®ç”Ÿæ´»è²»ç‡" value={postRetirementExpenseRatio} onChange={setPostRetirementExpenseRatio} unit="%" step={5} />
                             {spendingPattern === 'linear' && <div className="pt-2 border-t border-slate-200"><InputGroup label="æ¯å¹´ã®æ¸›å°‘ç‡" value={expenseDecayRate} onChange={setExpenseDecayRate} unit="%" step={0.1} /></div>}
                             {spendingPattern === 'ushape' && (
                                 <div className="pt-2 border-t border-slate-200 grid grid-cols-2 gap-2">
                                     <div className="col-span-2 text-[10px] font-bold text-slate-500">å„ãƒ•ã‚§ãƒ¼ã‚ºã®æ”¯å‡ºç‡</div>
                                     <InputGroup label="75æ­³~" value={ushapePhase1Ratio} onChange={setUshapePhase1Ratio} unit="%" step={5} />
                                     <InputGroup label="85æ­³~" value={ushapePhase2Ratio} onChange={setUshapePhase2Ratio} unit="%" step={5} />
                                 </div>
                             )}
                        </div>
                     </div>
                     </div>

                     <div className="border-t pt-2">
                      <p className="text-xs font-bold mb-2 text-slate-600 flex items-center gap-1"><Activity size={14}/> ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãã®ä»–åæ”¯</p>
                      <div className="space-y-2 mb-2 max-h-48 overflow-y-auto custom-scrollbar">
                        {events.map((event) => (
                          <div key={event.id} className={`text-xs p-2 rounded border flex flex-col gap-1 ${event.type === 'income' ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                            <div className="flex justify-between items-center"><span className="font-bold text-slate-700">{event.name}</span><button onClick={() => removeEvent(event.id)}><Trash2 size={12} className="text-slate-400 hover:text-red-500"/></button></div>
                            <div className="flex justify-between items-center text-[10px] text-slate-500">
                                <div>
                                    {event.isRecurring ? <span className="flex items-center gap-1"><Repeat size={10}/> {event.startAge}æ­³ ~ {event.endAge}æ­³</span> : <span>{event.startAge}æ­³ (å˜ç™º)</span>}
                                    <span className="ml-2 text-[9px] px-1 rounded bg-slate-100 border text-slate-500">{event.useInflation !== false ? 'ã‚¤ãƒ³ãƒ•ãƒ¬é€£å‹•' : 'å›ºå®šé¡'}</span>
                                </div>
                                <div className={`font-bold ${event.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{event.type === 'income' ? '+' : '-'}{event.amount}ä¸‡{event.isRecurring && '/å¹´'}</div>
                            </div>
                            {event.type === 'expense' && event.assetThreshold > 0 && (
                                <div className="text-[9px] text-orange-600 font-bold mt-1">
                                    â€» è³‡ç”£ {event.assetThreshold}ä¸‡æœªæº€ã§åœæ­¢
                                </div>
                            )}
                          </div>
                        ))}
                      </div>
                      <div className="bg-slate-50 p-2 rounded border border-slate-200 space-y-2">
                          <div className="flex gap-2">
                              <input type="text" placeholder="åç§°" value={newEvent.name} onChange={e => setNewEvent({...newEvent, name: e.target.value})} className="flex-1 p-1 text-xs border rounded"/>
                              <div className="flex bg-white rounded border overflow-hidden">
                                  <button onClick={() => setNewEvent({...newEvent, type: 'expense'})} className={`px-2 py-1 text-[10px] ${newEvent.type === 'expense' ? 'bg-red-100 text-red-700 font-bold' : 'text-slate-400'}`}>æ”¯å‡º</button>
                                  <button onClick={() => setNewEvent({...newEvent, type: 'income'})} className={`px-2 py-1 text-[10px] ${newEvent.type === 'income' ? 'bg-green-100 text-green-700 font-bold' : 'text-slate-400'}`}>åå…¥</button>
                              </div>
                          </div>
                          <div className="flex gap-2 items-center">
                              <div className="flex-1 flex items-center gap-1 bg-white border rounded px-1"><span className="text-[10px] text-slate-400">é‡‘é¡</span><input type="number" value={newEvent.amount} onChange={e => setNewEvent({...newEvent, amount: Number(e.target.value)})} className="w-full p-1 text-xs outline-none"/><span className="text-[10px] text-slate-400">ä¸‡</span></div>
                              <label className="flex items-center gap-1 text-[10px] cursor-pointer" title="ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã‚¤ãƒ³ãƒ•ãƒ¬ç‡ã«åˆã‚ã›ã¦é‡‘é¡ãŒå¢—åŠ ã—ã¾ã™"><input type="checkbox" checked={newEvent.useInflation !== false} onChange={e => setNewEvent({...newEvent, useInflation: e.target.checked})} className="accent-indigo-600"/><span>ã‚¤ãƒ³ãƒ•ãƒ¬é€£å‹•</span></label>
                              <label className="flex items-center gap-1 text-[10px] cursor-pointer"><input type="checkbox" checked={newEvent.isRecurring} onChange={e => setNewEvent({...newEvent, isRecurring: e.target.checked})} className="accent-indigo-600"/><span>æ¯å¹´</span></label>
                          </div>
                          <div className="flex gap-2 items-center">
                              <div className="flex items-center gap-1"><input type="number" value={newEvent.startAge} onChange={e => setNewEvent({...newEvent, startAge: Number(e.target.value)})} className="w-10 p-1 text-xs border rounded text-center"/><span className="text-[10px] text-slate-500">æ­³</span></div>
                              {newEvent.isRecurring && (<><span className="text-slate-400 text-[10px]">~</span><div className="flex items-center gap-1"><input type="number" value={newEvent.endAge} onChange={e => setNewEvent({...newEvent, endAge: Number(e.target.value)})} className="w-10 p-1 text-xs border rounded text-center"/><span className="text-[10px] text-slate-500">æ­³</span></div></>)}
                              <button onClick={addEvent} className="ml-auto bg-slate-700 text-white p-1.5 rounded hover:bg-slate-600 flex items-center gap-1 text-xs"><Plus size={12}/> è¿½åŠ </button>
                          </div>
                          {newEvent.type === 'expense' && (
                              <div className="flex items-center gap-2 mt-1">
                                  <label className="text-[10px] text-slate-500 flex items-center gap-1" title="è³‡ç”£æ®‹é«˜ãŒã“ã®å€¤ã‚’ä¸‹å›ã‚‹å ´åˆã¯æ”¯å‡ºã‚’å®Ÿè¡Œã—ã¾ã›ã‚“">å®Ÿè¡Œè³‡ç”£é–¾å€¤(ä¸‡)</label>
                                  <input type="number" value={newEvent.assetThreshold} onChange={e => setNewEvent({...newEvent, assetThreshold: Number(e.target.value)})} className="w-20 p-1 text-xs border rounded text-right"/>
                              </div>
                          )}
                      </div>
                     </div>
                 </div>
            </div>
          </div>

          {/* Right Panel */}
          <div className="lg:col-span-8 flex flex-col gap-4 h-full">
            {/* KPIs */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div className={`p-3 rounded-lg border-l-4 shadow-sm bg-white ${stats.successRate < 80 ? 'border-red-500' : 'border-green-500'}`}>
                    <div className="text-xs text-slate-500 font-bold">å…¨æœŸé–“ æ¯æ¸‡å›é¿ç‡</div>
                    <div className="text-xl font-bold">{formatPercent(stats.successRate, 1)}</div>
                </div>
                <div className="p-3 rounded-lg border-l-4 border-indigo-500 shadow-sm bg-white">
                    <div className="text-xs text-slate-500 font-bold">{lifeExpectancy}æ­³è³‡ç”£(ä¸­å¤®)</div>
                    <div className="text-xl font-bold">{formatCurrency(stats.finalP50/10000)}å„„å††</div>
                </div>
                 <div className="p-3 rounded-lg border-l-4 border-slate-400 shadow-sm bg-white">
                    <div className="text-xs text-slate-500 font-bold">å¼•é€€æ™‚è³‡ç”£(ä¸­å¤®)</div>
                    <div className="text-xl font-bold">{formatCurrency(stats.assetAtRetirement/10000)}å„„å††</div>
                </div>
                 <div className="p-3 rounded-lg border-l-4 border-blue-400 shadow-sm bg-white">
                    <div className="text-xs text-slate-500 font-bold mb-1">å¹´é½¢åˆ¥ æ¯æ¸‡å›é¿ç‡</div>
                    <div className="flex flex-col gap-0.5 text-xs">
                        <div className="flex justify-between"><span>85æ­³:</span> <span className="font-bold">{formatPercent(stats.survivalRates?.age85, 1)}</span></div>
                        <div className="flex justify-between"><span>90æ­³:</span> <span className="font-bold">{formatPercent(stats.survivalRates?.age90, 1)}</span></div>
                        <div className="flex justify-between"><span>95æ­³:</span> <span className="font-bold">{formatPercent(stats.survivalRates?.age95, 1)}</span></div>
                    </div>
                </div>
            </div>
            
            {/* Chart */}
            <div className="bg-white p-4 rounded-xl shadow-md border border-slate-200 h-[400px]">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm text-slate-700 flex items-center gap-2">è³‡ç”£æ¨ç§»</h3>
                    <div className="flex bg-slate-100 p-1 rounded">
                        <button onClick={() => setChartMode('final_year')} className={`px-3 py-1 text-xs rounded transition-colors ${chartMode === 'final_year' ? 'bg-white shadow font-bold text-indigo-600' : 'text-slate-500'}`}>æœ€çµ‚å¹´åŸºæº–</button>
                        <button onClick={() => setChartMode('yearly')} className={`px-3 py-1 text-xs rounded transition-colors ${chartMode === 'yearly' ? 'bg-white shadow font-bold text-indigo-600' : 'text-slate-500'}`}>å„å¹´åŸºæº–</button>
                    </div>
                </div>
                <ResponsiveContainer width="100%" height="100%">
                  <ComposedChart data={simulationData} margin={{top:10, right:10, left:0, bottom:0}}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                    <XAxis dataKey="age" unit="æ­³" tick={{fontSize:10}}/>
                    <YAxis tickFormatter={yAxisTickFormatter} tick={{fontSize:10}} width={40}/>
                    <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} formatter={(val) => Math.round(val).toLocaleString() + 'ä¸‡å††'} labelFormatter={(label) => `${label}æ­³`} />
                    <Legend />
                    <Area type="monotone" dataKey={getKey('optimistic_total')} stackId="1" stroke="none" fill="#e0e7ff" name="ç¯„å›²"/>
                    <Line type="monotone" dataKey={getKey('central_total')} stroke="#4f46e5" strokeWidth={2} dot={false} name="ä¸­å¤®å€¤"/>
                    <Line type="monotone" dataKey={getKey('pessimistic_total')} stroke="#9ca3af" strokeWidth={1} dot={false} name="æ‚²è¦³"/>
                  </ComposedChart>
                </ResponsiveContainer>
            </div>

            {/* Scenario Summary Cards (New) */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                <ScenarioCard title="æ‚²è¦³ã‚·ãƒŠãƒªã‚ª (ä¸‹ä½10%)" color="blue" data={summaryMetrics.pessimistic} lifeExpectancy={lifeExpectancy} />
                <ScenarioCard title="ä¸­å¤®ã‚·ãƒŠãƒªã‚ª (ä¸­å¤®å€¤)" color="indigo" data={summaryMetrics.central} lifeExpectancy={lifeExpectancy} isMain />
                <ScenarioCard title="æ¥½è¦³ã‚·ãƒŠãƒªã‚ª (ä¸Šä½10%)" color="green" data={summaryMetrics.optimistic} lifeExpectancy={lifeExpectancy} />
            </div>

            {/* Breakdown Chart (Bar) */}
            <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border border-slate-200 h-[400px] flex flex-col">
               <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold text-slate-700">è³‡ç”£å†…è¨³è©³ç´° ({breakdownScenario === 'p10' ? 'æ‚²è¦³' : breakdownScenario === 'p50' ? 'ä¸­å¤®' : 'æ¥½è¦³'}ã‚·ãƒŠãƒªã‚ª)</h3>
                  <div className="flex bg-slate-100 p-1 rounded text-xs">
                      <button onClick={() => setBreakdownScenario('p10')} className={`px-3 py-1 rounded ${breakdownScenario === 'p10' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>æ‚²è¦³</button>
                      <button onClick={() => setBreakdownScenario('p50')} className={`px-3 py-1 rounded ${breakdownScenario === 'p50' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>ä¸­å¤®</button>
                      <button onClick={() => setBreakdownScenario('p90')} className={`px-3 py-1 rounded ${breakdownScenario === 'p90' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>æ¥½è¦³</button>
                  </div>
               </div>
               <div className="flex-1 w-full min-h-0">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={simulationData} margin={{ top: 10, right: 30, left: 10, bottom: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                    <XAxis dataKey="age" unit="æ­³" tick={{fontSize: 12}} minTickGap={30} />
                    <YAxis tickFormatter={yAxisTickFormatter} width={60} tick={{fontSize: 12}} />
                    <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} formatter={(val, name) => [Math.round(val).toLocaleString() + 'ä¸‡å††', name]} labelFormatter={(label) => `${label}æ­³æ™‚ç‚¹ (${breakdownScenario === 'p10' ? 'æ‚²è¦³' : breakdownScenario === 'p50' ? 'ä¸­å¤®' : 'æ¥½è¦³'}ã‚·ãƒŠãƒªã‚ª)`} />
                    <Legend />
                    <ReferenceLine y={0} stroke="#64748b" />
                    <Bar dataKey={`${getKey(`${breakdownPrefix}_cash`)}`} name="ç¾é‡‘" stackId="a" fill="#3b82f6" />
                    <Bar dataKey={`${getKey(`${breakdownPrefix}_nisa`)}`} name="NISA" stackId="a" fill="#22c55e" />
                    <Bar dataKey={`${getKey(`${breakdownPrefix}_taxable`)}`} name="ç‰¹å®šå£åº§" stackId="a" fill="#f59e0b" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* AI & Table */}
             <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-3 rounded-xl border border-indigo-100 flex justify-between items-center">
                <div className="text-xs font-bold text-indigo-800 flex items-center gap-1"><Bot size={16}/> AIã‚³ãƒ¼ãƒ</div>
                <button onClick={generateAiAdvice} disabled={isAiLoading} className="bg-white border px-3 py-1 rounded text-xs hover:bg-indigo-50">
                    {isAiLoading ? 'åˆ†æä¸­...' : 'è¨ºæ–­ã™ã‚‹'}
                </button>
             </div>
             {aiAdvice && <div className="bg-white p-3 rounded border text-xs leading-relaxed whitespace-pre-wrap">{aiAdvice}</div>}

             <div className={`bg-white rounded-xl shadow border border-slate-200 overflow-hidden ${isTableMaximized ? 'fixed inset-0 z-50 m-0 rounded-none h-full flex flex-col' : ''}`}>
                <div className="p-3 bg-slate-50 border-b flex justify-between items-center cursor-pointer" onClick={() => setShowTable(!showTable)}>
                    <span className="font-bold text-sm flex items-center gap-2"><TableIcon size={14}/> è©³ç´°ãƒ‡ãƒ¼ã‚¿</span>
                    <div className="flex gap-2 items-center">
                        <button onClick={(e) => { e.stopPropagation(); setIsTableMaximized(!isTableMaximized); }} className="p-1 hover:bg-slate-200 rounded text-slate-500" title={isTableMaximized ? "å…ƒã«æˆ»ã™" : "æœ€å¤§åŒ–"}>
                            {isTableMaximized ? <Minimize2 size={16}/> : <Maximize2 size={16}/>}
                        </button>
                        {!isTableMaximized && (showTable ? <ChevronUp size={16}/> : <ChevronDown size={16}/>)}
                    </div>
                </div>
                {(showTable || isTableMaximized) && (
                    <div className={`overflow-x-auto ${isTableMaximized ? 'flex-1 h-full' : 'max-h-64'}`}>
                         <div className="flex gap-2 p-2 bg-slate-50">
                            {['pessimistic','central','optimistic'].map(s => (
                                <button key={s} onClick={()=>setActiveScenarioTab(s)} className={`px-3 py-1 rounded text-xs ${activeScenarioTab===s ? 'bg-indigo-600 text-white' : 'bg-white border'}`}>
                                    {s==='pessimistic'?'æ‚²è¦³':s==='central'?'ä¸­å¤®':'æ¥½è¦³'}
                                </button>
                            ))}
                        </div>
                        <table className="w-full text-xs text-right border-collapse">
                            <thead className="bg-slate-100 sticky top-0 z-10">
                                <tr>
                                    <th className="p-2 text-left">å¹´é½¢</th>
                                    <th className="p-2">ã‚¤ãƒ™ãƒ³ãƒˆ</th>
                                    <th className="p-2 text-green-600">ä¸–å¸¯åå…¥<br/><span className="text-[9px] text-slate-400">é€€è·é‡‘è¾¼</span></th>
                                    <th className="p-2 text-red-500" title="åŸºæœ¬ç”Ÿæ´»è²»+ä½å±…è²»+æ•™è‚²è²»+ã‚¤ãƒ™ãƒ³ãƒˆæ”¯å‡º">ä¸–å¸¯æ”¯å‡º<span className="text-[9px] text-slate-400">â„¹ï¸</span></th>
                                    <th className="p-2 border-r">åæ”¯<br/><span className="text-[9px] text-slate-400">é‹ç”¨ç›Šé™¤</span></th>
                                    <th className="p-2 bg-blue-50">ç¾é‡‘</th>
                                    <th className="p-2 bg-green-50">NISA</th>
                                    <th className="p-2 bg-yellow-50">ç‰¹å®š</th>
                                    <th className="p-2 font-bold">ç·é¡</th>
                                    <th className="p-2 text-slate-400">ãƒªã‚¿ãƒ¼ãƒ³</th>
                                    <th className="p-2 text-orange-400 border-l">å–å´©</th>
                                    <th className="p-2 text-red-400">ç¨é‡‘</th>
                                </tr>
                            </thead>
                            <tbody>
                                {simulationData.map(row => (
                                    <tr key={row.age} className="border-b hover:bg-slate-50 group">
                                        <td className="p-2 text-left font-bold">{row.age}</td>
                                        <td className="p-2 text-left truncate max-w-[100px] text-slate-500" title={row.event}>{row.event}</td>
                                        <td className="p-2 text-green-600">{row.income.toLocaleString()}</td>
                                        <td className="p-2 text-red-500 relative cursor-help" title={`å†…è¨³:\nåŸºæœ¬ç”Ÿæ´»è²»: ${row.baseLivingCost.toLocaleString()}\nä½å±…è²»: ${row.housingCost.toLocaleString()}\næ•™è‚²è²»: ${row.educationCost.toLocaleString()}\nã‚¤ãƒ™ãƒ³ãƒˆ: ${row.eventExpense.toLocaleString()}`}>
                                            {row.expense.toLocaleString()}
                                        </td>
                                        <td className={`p-2 border-r ${row.annualBalance<0?'text-red-500':''}`}>{row.annualBalance.toLocaleString()}</td>
                                        <td className="p-2 bg-blue-50/20">{row[getKey(`${activeScenarioTab}_cash`)].toLocaleString()}</td>
                                        <td className="p-2 bg-green-50/20">{row[getKey(`${activeScenarioTab}_nisa`)].toLocaleString()}</td>
                                        <td className="p-2 bg-yellow-50/20">{row[getKey(`${activeScenarioTab}_taxable`)].toLocaleString()}</td>
                                        <td className="p-2 font-bold">{row[getKey(`${activeScenarioTab}_total`)].toLocaleString()}</td>
                                        <td className="p-2 text-slate-400">{row[getKey(`${activeScenarioTab}_return`)]}%</td>
                                        <td className="p-2 text-orange-400 border-l">{row[getKey(`${activeScenarioTab}_withdrawal`)].toLocaleString()}</td>
                                        <td className="p-2 text-red-400">{row[getKey(`${activeScenarioTab}_tax`)].toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
             </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// UI Components
const InputGroup = ({ label, value, onChange, unit, step=1, icon, helpText }) => (
  <div className="flex items-center justify-between">
    <label className="text-[10px] text-slate-500 flex items-center gap-1" title={helpText}>
        {icon}{label}
        {helpText && <span className="text-[9px] text-slate-300 ml-1">?</span>}
    </label>
    <div className="flex items-center w-24">
        <input type="number" step={step} value={value} onChange={e => onChange(Number(e.target.value))} className="w-full p-1 text-xs border rounded text-right" />
        <span className="text-[10px] text-slate-400 ml-1 w-4">{unit}</span>
    </div>
  </div>
);